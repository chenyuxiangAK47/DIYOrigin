# OriginSystemPatches.cs 代码拆分方案

## 当前问题分析

**文件规模**: 6647行，单一文件包含所有职责

**主要职责混合**:
1. Harmony Patches (3个Patch类)
2. 菜单工厂方法 (30+个CreateXXXMenu)
3. 路由逻辑 (ResolveNextMenuId, GetFlavorNodeMenuId)
4. 工具方法 (ThrottledLog, 反射工具)
5. 回调方法 (100+个OnSelect/Args方法)
6. 大量中文TextObject (容易编码错误)

**风险点**:
- 单文件过大，Cursor容易改错括号/引号
- 职责不清，修改时容易影响其他部分
- 中文字符串分散，编码问题频发
- 路由逻辑和菜单创建耦合

---

## 拆分目标结构

```
SubModule/
├── Patches/                          # Harmony Patches
│   ├── AddParentsMenuPatch.cs
│   ├── OnNarrativeMenuOptionSelectedPatch.cs
│   └── TrySwitchToNextMenuPatch.cs
│
├── Menus/                            # 菜单工厂
│   ├── OriginTypeSelectionMenu.cs
│   ├── Preset/
│   │   ├── PresetOriginSelectionMenu.cs
│   │   └── Nodes/
│   │       ├── WanderingPrinceNodeMenus.cs
│   │       ├── RebelChiefNodeMenus.cs
│   │       ├── SlaveEscapeNodeMenus.cs
│   │       ├── MinorNobleNodeMenus.cs
│   │       ├── MigrantChiefNodeMenus.cs
│   │       ├── ArmyDeserterNodeMenus.cs
│   │       ├── TradeProtectorNodeMenus.cs
│   │       ├── KhansMercenaryNodeMenus.cs
│   │       ├── FreeCossackNodeMenus.cs
│   │       └── OldGuardAvengerNodeMenus.cs
│   └── NonPreset/
│       ├── NonPresetCultureAnchorMenu.cs
│       ├── NonPresetSocialOriginMenu.cs
│       ├── NonPresetSkillBackgroundMenu.cs
│       ├── NonPresetStartingConditionMenu.cs
│       ├── NonPresetStartLocationTypeMenu.cs
│       ├── NonPresetValuableItemMenu.cs
│       ├── NonPresetContactTypeMenu.cs
│       └── Roles/
│           ├── NonPresetNomadRoleMenu.cs
│           ├── NonPresetCraftsmanTradeMenu.cs
│           ├── NonPresetCaravanRoleMenu.cs
│           ├── NonPresetMinorClanPositionMenu.cs
│           ├── NonPresetRefugeeBurdenMenu.cs
│           ├── NonPresetPeasantRoleMenu.cs
│           └── NonPresetUrbanPoorRoleMenu.cs
│
├── Routing/                          # 路由逻辑
│   ├── OriginMenuRouter.cs          # 核心路由方法
│   ├── OriginRoutes.Khuzait.cs     # 预设出身路由表
│   └── OriginRoutes.NonPreset.cs   # 非预设出身路由表
│
├── Util/                             # 工具类
│   ├── OriginLog.cs                 # 日志工具
│   └── ReflectionUtil.cs           # 反射工具
│
└── Text/                             # 文本集中管理
    └── OriginTexts.cs               # 临时集中所有TextObject
    # 最终目标: module_strings.xml (UTF-8)
```

---

## 拆分实施步骤（6个阶段）

### 阶段1: 基础设施拆分（最安全）

**目标**: 把日志和Patch独立出来，不改任何业务逻辑

**任务**:
1. 创建 `Util/OriginLog.cs` - 移动 `ThrottledLog` 和相关日志方法
2. 创建 `Patches/AddParentsMenuPatch.cs` - 移动整个 `AddParentsMenuPatch` 类
3. 将 `OriginSystemPatches` 改为 `partial class`

**验收标准**: 
- 编译通过
- 功能不变
- 所有引用自动生效（partial class优势）

---

### 阶段2: 菜单工厂拆分 - OriginTypeSelection

**目标**: 拆分最关键的菜单选择入口

**任务**:
1. 创建 `Menus/OriginTypeSelectionMenu.cs`
2. 移动以下方法:
   - `CreateOriginTypeSelectionMenu`
   - `GetOriginTypeMenuCharacterArgs`
   - `GetPresetOriginArgs` / `PresetOriginOnCondition` / `PresetOriginOnSelect`
   - `GetNonPresetOriginArgs` / `NonPresetOriginOnCondition` / `NonPresetOriginOnSelect`

**验收标准**: 编译通过，菜单选择功能正常

---

### 阶段3: 预设出身菜单拆分

**目标**: 按出身拆分预设菜单，每个出身一个文件

**任务**: 创建 `Menus/Preset/Nodes/` 下的文件，每个文件包含:
- `CreateXXXNode1Menu` 到 `CreateXXXNodeNMenu`
- 所有相关的 `GetXXXArgs` 方法
- 所有相关的 `XXXOnSelect` 方法
- 所有相关的 `GetXXXCharacterArgs` 方法

**文件列表**:
- `WanderingPrinceNodeMenus.cs` (Node1, SubNode, Node3, Node4)
- `RebelChiefNodeMenus.cs` (Node1-4)
- `SlaveEscapeNodeMenus.cs` (Node1-5)
- `MinorNobleNodeMenus.cs` (Node1-4)
- `MigrantChiefNodeMenus.cs` (Node1-4)
- `ArmyDeserterNodeMenus.cs` (Node1-4)
- `TradeProtectorNodeMenus.cs` (Node1-4)
- `KhansMercenaryNodeMenus.cs` (Node1-4)
- `FreeCossackNodeMenus.cs` (Node1-4)
- `OldGuardAvengerNodeMenus.cs` (Node1-4)

**额外**: 创建 `Menus/Preset/PresetOriginSelectionMenu.cs` 包含:
- `CreatePresetOriginSelectionMenu`
- 所有 `GetXXXArgs` / `XXXOnCondition` / `XXXOnSelect` 方法

**验收标准**: 编译通过，所有预设出身菜单正常显示

---

### 阶段4: 非预设菜单拆分

**目标**: 拆分非预设菜单和角色菜单

**任务**:
1. 核心菜单 (直接创建):
   - `NonPresetCultureAnchorMenu.cs`
   - `NonPresetSocialOriginMenu.cs`
   - `NonPresetSkillBackgroundMenu.cs`
   - `NonPresetStartingConditionMenu.cs`
   - `NonPresetStartLocationTypeMenu.cs`
   - `NonPresetValuableItemMenu.cs`
   - `NonPresetContactTypeMenu.cs`

2. 角色菜单 (Roles目录):
   - `NonPresetNomadRoleMenu.cs`
   - `NonPresetCraftsmanTradeMenu.cs`
   - `NonPresetCaravanRoleMenu.cs`
   - `NonPresetMinorClanPositionMenu.cs`
   - `NonPresetRefugeeBurdenMenu.cs`
   - `NonPresetPeasantRoleMenu.cs`
   - `NonPresetUrbanPoorRoleMenu.cs`

**验收标准**: 编译通过，非预设流程完整可用

---

### 阶段5: 路由逻辑拆分

**目标**: 独立路由逻辑，数据化路由表

**任务**:
1. 创建 `Patches/TrySwitchToNextMenuPatch.cs` - 移动整个Patch类
2. 创建 `Routing/OriginMenuRouter.cs` - 移动路由方法:
   - `ResolveNextMenuId` → 改为调用路由表
   - `GetFlavorNodeMenuId` → 改为查表
   - `DumpCandidates` → 工具方法
3. 创建 `Routing/OriginRoutes.Khuzait.cs` - 预设出身路由表
4. 创建 `Routing/OriginRoutes.NonPreset.cs` - 非预设路由表

**路由表结构**:
```csharp
// OriginRoutes.Khuzait.cs
public static class KhuzaitRoutes
{
    // 预设出身选择 → Node1
    public static readonly Dictionary<string, string> PresetOriginToNode1 = new()
    {
        { "khuzait_rebel_chief", "rebel_chief_node1" },
        { "khuzait_minor_noble", "minor_noble_node1" },
        // ...
    };
    
    // 节点流转规则 (curMenuId, optionId) → nextMenuId
    public static readonly Dictionary<(string cur, string opt), string> NodeTransitions = new()
    {
        { ("rebel_chief_node1", "rebel_reason_refuse_tribute"), "rebel_chief_node2" },
        // ...
    };
}
```

**验收标准**: 
- 编译通过
- 路由行为完全一致
- 日志显示路由正确

---

### 阶段6: 文本集中管理（降低编码错误）

**目标**: 把所有中文TextObject集中管理

**任务**:
1. 创建 `Text/OriginTexts.cs` - 定义所有文本常量
2. 替换所有 `new TextObject("中文...")` 为 `OriginTexts.XXX`
3. 统一使用UTF-8编码

**示例**:
```csharp
// Text/OriginTexts.cs
public static class OriginTexts
{
    public static TextObject OriginTypeSelectionTitle => new TextObject("选择你的出身类型");
    public static TextObject PresetOriginOption => new TextObject("预设出身");
    // ...
}

// 使用
var menu = new NarrativeMenu(..., OriginTexts.OriginTypeSelectionTitle, ...);
```

**最终目标**: 迁移到 `module_strings.xml`，使用 `{=key}` 引用

**验收标准**: 
- 编译通过
- 所有文本正常显示
- 编码错误减少

---

## 关键技术点

### 1. 使用 Partial Class

**优势**: 不需要修改任何调用点

```csharp
// OriginSystemPatches.cs (主文件)
namespace OriginSystemMod
{
    public static partial class OriginSystemPatches
    {
        // 保留一些共享的静态字段
    }
}

// Patches/AddParentsMenuPatch.cs
namespace OriginSystemMod
{
    public static partial class OriginSystemPatches
    {
        [HarmonyPatch(typeof(CharacterCreationCampaignBehavior), "AddParentsMenu")]
        public static class AddParentsMenuPatch
        {
            // ...
        }
    }
}
```

### 2. 路由表数据化

**当前问题**: 巨大的switch/if链，难以维护

**解决方案**: Dictionary映射表

```csharp
// 当前 (难以维护)
if (curMenuId == "non_preset_social_origin")
{
    if (optId == "social_origin_nomad_camp")
        return "non_preset_nomad_role";
    // ...
}

// 改进 (清晰易维护)
private static readonly Dictionary<string, Dictionary<string, string>> SocialOriginRoutes = new()
{
    { "nomad_camp", new() { { "default", "non_preset_nomad_role" } } },
    { "urban_artisan", new() { { "default", "non_preset_artisan_trade" } } },
    // ...
};
```

### 3. 统一日志格式

**当前**: 日志格式不统一，难以追踪

**改进**: 固定格式，关键字段

```csharp
// 点击时
Debug.Print($"[OS] Click: menu={menuId} opt={optId} selected={hasSelected}", ...);

// 路由前
Debug.Print($"[OS] Route: cur={curMenuId} opt={optId} candidates=[{string.Join(",", candidates)}]", ...);

// 路由后
Debug.Print($"[OS] Route: resolved={nextMenuId} switched={success}", ...);
```

---

## 拆分后的优势

1. **可维护性**: 每个文件职责单一，修改影响范围小
2. **可读性**: 文件大小合理，容易理解
3. **可测试性**: 可以单独测试每个模块
4. **减少错误**: 编码错误、括号错误影响范围小
5. **团队协作**: 多人可以同时修改不同文件

---

## 注意事项

1. **逐步拆分**: 一次只做一个阶段，确保编译通过再继续
2. **保持功能**: 拆分过程中功能不能变，只做"搬家"
3. **测试验证**: 每个阶段完成后都要测试功能
4. **版本控制**: 每个阶段提交一次，方便回滚
5. **文档更新**: 拆分后更新相关文档

---

## 下一步行动

建议按以下顺序执行：

1. ✅ **阶段1** - 基础设施拆分（最安全，先做）
2. ✅ **阶段2** - OriginTypeSelection拆分
3. ✅ **阶段3** - 预设菜单拆分（可以分批，每次2-3个出身）
4. ✅ **阶段4** - 非预设菜单拆分
5. ✅ **阶段5** - 路由逻辑拆分
6. ✅ **阶段6** - 文本集中管理

每个阶段完成后，可以暂停测试，确保稳定后再继续。

































