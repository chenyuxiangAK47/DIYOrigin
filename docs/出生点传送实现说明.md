# 出生点传送实现说明

## 概述

按照 ChatGPT 建议，实现了标准的"出生在指定村子"功能，用于逃奴和侠义骑士出身。

## 核心实现

### 1. OriginSpawnHelper 辅助类

位置：`SubModule/OriginSpawnHelper.cs`

**主要方法：**
- `SpawnPlayerAtVillage(string villageId, bool enterSettlementMenu = true)` - 传送玩家到指定村子
- `FindVillageByDirection(string direction)` - 根据方向查找村子（用于逃奴）
- `FindVillageByCulture(string cultureId)` - 根据文化查找村子（用于侠义骑士）

**关键特性：**
- ✅ 使用 `Settlement.StringId` 精确指定村子
- ✅ 移动 `MobileParty.MainParty.Position2D`（不是只移动 Hero）
- ✅ 可选使用 `EnterSettlementAction.ApplyForParty` 进入村子菜单
- ✅ 设置 `Clan.PlayerClan.HomeSettlement`

### 2. OnCharacterCreationIsOverEvent 监听

位置：`SubModule/OriginSystemCampaignBehavior.cs`

**按照 ChatGPT 建议：**
- ✅ 在 `OnCharacterCreationIsOverEvent` 中应用出生点（最稳的时机）
- ✅ 使用 `_hasAppliedSpawnLocation` 标志防止重复执行
- ✅ 在 `SyncData` 中序列化标志，防止读档后重复触发
- ✅ 在 `OnTick` 中提供兜底逻辑（如果 `OnCharacterCreationIsOver` 失败）

### 3. 数据流

#### 逃奴出身（SlaveEscape）

1. **Node5 选择时**（`SlaveEscapeNodes.cs`）：
   ```csharp
   SaveSlaveEscapeStartingLocation("desert"); // 或 "empire"
   ```
   - 保存 `OriginSystemHelper.PendingStartDirection = "desert"`
   - 保存 `OriginSystemHelper.PendingStartSettlementId = null`（延迟查找）

2. **角色创建结束后**（`OnCharacterCreationIsOver`）：
   - 如果 `PendingStartSettlementId` 为空，调用 `OriginSpawnHelper.FindVillageByDirection(direction)` 查找
   - 调用 `OriginSpawnHelper.SpawnPlayerAtVillage(villageId, enterSettlementMenu: true)`

#### 侠义骑士出身（ExpeditionKnight）

1. **应用出身时**（`VlandiaOriginSystem.cs`）：
   ```csharp
   OriginSystemHelper.PendingVlandiaStartLocation = "nord"; // 或 "aserai", "battania"
   ```

2. **角色创建结束后**（`OnCharacterCreationIsOver`）：
   - 调用 `OriginSpawnHelper.FindVillageByCulture(location)` 查找
   - 调用 `OriginSpawnHelper.SpawnPlayerAtVillage(villageId, enterSettlementMenu: true)`

## 关键点

### ✅ 正确做法

1. **时机**：在 `OnCharacterCreationIsOverEvent` 中应用（不是 `OnSessionLaunched`）
2. **村子 ID**：使用 `Settlement.StringId`（如 `"village_steppe_1"`），不是名字
3. **移动队伍**：移动 `MobileParty.MainParty.Position2D`，不是只移动 Hero
4. **进入菜单**：使用 `EnterSettlementAction.ApplyForParty(party, target)` 进入村子菜单
5. **防止重复**：使用 `_hasAppliedSpawnLocation` 标志 + `SyncData` 序列化

### ❌ 容易踩坑的点

1. **时机不对**：`OnSessionLaunched` 不靠谱，会被原生流程覆盖
2. **村子 ID 写错**：要用 `Settlement.StringId`，不是名字
3. **只移动 Hero**：必须移动 `MobileParty.MainParty`，否则会卡死
4. **进入菜单方法不对**：使用 `EnterSettlementAction.ApplyForParty`，不是直接设置位置

## 代码示例

### 在 Node 选择时保存出生点

```csharp
private static void SlaveDirectionDesertOnSelect(CharacterCreationManager manager) 
{ 
    OriginLog.Info("用户选择战奴逃亡-Node5-留沙漠"); 
    OriginSystemHelper.SelectedPresetOriginNodes["khz_node_ex_slave_direction"] = "desert"; 
    OriginSystemHelper.OriginSelectionDone = true; 
    
    // 保存期望出生位置：沙漠深处（阿塞莱的沙漠城市）
    SaveSlaveEscapeStartingLocation("desert");
}
```

### 在 OnCharacterCreationIsOver 中应用

```csharp
private void OnCharacterCreationIsOver()
{
    // 防止重复执行
    if (_hasAppliedSpawnLocation) return;
    
    // 处理逃奴出生点
    if (!string.IsNullOrEmpty(OriginSystemHelper.PendingStartDirection))
    {
        string villageId = OriginSystemHelper.PendingStartSettlementId;
        
        // 如果没有保存具体的 settlementId，根据 direction 查找
        if (string.IsNullOrEmpty(villageId))
        {
            villageId = OriginSpawnHelper.FindVillageByDirection(OriginSystemHelper.PendingStartDirection);
        }

        if (!string.IsNullOrEmpty(villageId))
        {
            bool success = OriginSpawnHelper.SpawnPlayerAtVillage(villageId, enterSettlementMenu: true);
            if (success)
            {
                _hasAppliedSpawnLocation = true;
                OriginSystemHelper.PendingStartDirection = null;
                OriginSystemHelper.PendingStartSettlementId = null;
            }
        }
    }
}
```

## 参考

- ChatGPT 建议文档（用户提供）
- `OriginSpawnHelper.cs` - 标准实现模板
- `OriginSystemCampaignBehavior.cs` - 事件监听和应用逻辑
