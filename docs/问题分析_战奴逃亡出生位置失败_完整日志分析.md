# é—®é¢˜åˆ†æï¼šæˆ˜å¥´é€ƒäº¡å‡ºç”Ÿä½ç½®å¤±è´¥ï¼ˆå®Œæ•´æ—¥å¿—åˆ†æï¼‰

**æ—¥æœŸï¼š** 2024-12-19  
**æ›´æ–°æ—¶é—´ï¼š** 2024-12-19ï¼ˆå·²æŒ‰ ChatGPT å»ºè®®ä¿®å¤ï¼‰  
**é—®é¢˜ï¼š** é€‰æ‹©"æˆ˜å¥´é€ƒäº¡" â†’ "é€ƒå‘æ²™æ¼ æ·±å¤„"åï¼Œå‡ºç”Ÿä½ç½®ä»åœ¨é©¬å‡¯å¸ƒï¼ˆåº“å¡ç‰¹åŸå¸‚ï¼‰ï¼Œè€Œä¸æ˜¯é¢„æœŸçš„å¤äºšå…¹æœ€å—ç«¯æ‘åº„å¾€å—çš„æ²™æ¼ æ·±å¤„

---

## âœ… ChatGPT æŒ‡æ­£æ€»ç»“

**æ ¸å¿ƒåˆ¤æ–­ï¼š** ä»æ—¥å¿—é“¾è·¯çœ‹ï¼ŒçœŸæ­£æŠŠ"å‡ºç”Ÿç‚¹è®¾ç½®"å¹²æ‰çš„ï¼Œä¸æ˜¯ teleport ä»£ç å†™é”™ï¼Œè€Œæ˜¯**çŠ¶æ€åœ¨å…³é”®æ—¶åˆ»è¢« ResetState æ¸…ç©ºäº†**ï¼Œå¯¼è‡´åç»­æ ¹æœ¬æ²¡æœºä¼šæ‰§è¡Œ Apply / Teleportã€‚

**å·²å®æ–½çš„ä¿®å¤ï¼š**
1. âœ… ResetState åŠ ä¿æŠ¤æ¡ä»¶ï¼ˆæ–¹æ¡ˆ1ï¼‰
2. âœ… ResetState æ‰“å°è°ƒç”¨æ ˆ
3. âœ… OnSessionLaunched æ”¹ç”¨ OriginLogï¼ˆè‡ªè¯æ—¥å¿—ï¼‰
4. âœ… ApplyPresetOrigin å…¥å£æ—¥å¿—

---

## ğŸ” æ—¥å¿—åˆ†æ

### å…³é”®æ—¥å¿—æ—¶é—´çº¿

```
[15:20:36.905] [OS] Select: menu=preset_origin_selection option=khuzait_slave_escape
[15:20:36.905] [OS] Postfix: SelectedOption = khuzait_slave_escape (æˆ˜å¥´é€ƒäº¡)
[15:20:37.475] [OS] Switch: cur=preset_origin_selection opt=khuzait_slave_escape resolved=slave_escape_node1
[15:20:46.238] [OS] Select: menu=slave_escape_node5 option=slave_direction_desert
[15:20:46.238] [OS] [SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert
[15:20:49.228] [OS] Switch: cur=slave_escape_node5 opt=slave_direction_desert resolved=NULL
[15:21:03.833] [OS][WARN] [ResetState] æ¸…ç©ºäº† PendingStartDirection=desert PendingStartSettlementId=null
[15:20:01.758] [OriginSystem] çŠ¶æ€å·²é‡ç½®
[15:20:09.646] [OriginSystem] CampaignBehavior å·²æ·»åŠ 
[15:21:03.833] [OriginSystem] çŠ¶æ€å·²é‡ç½®
```

### é—®é¢˜æµç¨‹

1. âœ… **ç”¨æˆ·é€‰æ‹©æˆ˜å¥´é€ƒäº¡**ï¼š`khuzait_slave_escape`
2. âœ… **è·¯ç”±æˆåŠŸ**ï¼šè·³è½¬åˆ° `slave_escape_node1`
3. âœ… **ç”¨æˆ·é€‰æ‹©æ²™æ¼ æ·±å¤„**ï¼š`slave_direction_desert`
4. âœ… **èŠ‚ç‚¹é€‰æ‹©ä¿å­˜æˆåŠŸ**ï¼š`[SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert`
5. âŒ **ResetState æ¸…ç©ºçŠ¶æ€**ï¼š`[ResetState] æ¸…ç©ºäº† PendingStartDirection=desert`
6. âŒ **æ²¡æœ‰ ApplyPresetOrigin æ—¥å¿—**ï¼šè¯´æ˜ `ApplyPresetOrigin` æ²¡æœ‰è¢«è°ƒç”¨
7. âŒ **æ²¡æœ‰ [SlaveEscape][Apply] æ—¥å¿—**ï¼šè¯´æ˜ `ApplySlaveEscapeNode5` æ²¡æœ‰è¢«è°ƒç”¨
8. âŒ **æ²¡æœ‰ [SlaveEscape][Teleport] æ—¥å¿—**ï¼šè¯´æ˜ `SetSlaveEscapeStartingLocation` æ²¡æœ‰è¢«è°ƒç”¨

---

## ğŸ› æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1ï¼šApplyPresetOrigin æ²¡æœ‰è¢«è°ƒç”¨

**è¯æ®ï¼š**
- æ—¥å¿—ä¸­æ²¡æœ‰ `[OriginSystem] å·²åº”ç”¨é¢„è®¾å‡ºèº«: khuzait_slave_escape`
- æ—¥å¿—ä¸­æ²¡æœ‰ `[SlaveEscape][Apply] ApplySlaveEscapeNode5 è¢«è°ƒç”¨` çš„æ—¥å¿—

**å¯èƒ½çš„åŸå› ï¼š**

1. **OnSessionLaunched æ²¡æœ‰è¢«è°ƒç”¨**
   - æ—¥å¿—ä¸­æœ‰ `[OriginSystem] CampaignBehavior å·²æ·»åŠ `ï¼Œè¯´æ˜ CampaignBehavior å·²æ³¨å†Œ
   - ä½†æ²¡æœ‰çœ‹åˆ° `OnSessionLaunched` çš„è°ƒç”¨æ—¥å¿—

2. **OnSessionLaunched è°ƒç”¨æ—¶æ¡ä»¶ä¸æ»¡è¶³**
   - `OriginSystemHelper.IsPresetOrigin` å¯èƒ½ä¸º `false`
   - `OriginSystemHelper.SelectedPresetOriginId` å¯èƒ½ä¸º `null` æˆ–ç©ºå­—ç¬¦ä¸²
   - å¯èƒ½è¢« `ResetState` æ¸…ç©ºäº†

3. **ResetState è¿‡æ—©æ¸…ç©ºçŠ¶æ€**
   - æ—¥å¿—æ˜¾ç¤ºï¼š`[ResetState] æ¸…ç©ºäº† PendingStartDirection=desert`
   - `ResetState` å¯èƒ½åœ¨è§’è‰²åˆ›å»ºè¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œæ¸…ç©ºäº† `IsPresetOrigin` å’Œ `SelectedPresetOriginId`

### é—®é¢˜2ï¼šèŠ‚ç‚¹é€‰æ‹©å¯èƒ½æœªæ­£ç¡®ä¿å­˜

**è¯æ®ï¼š**
- æ—¥å¿—ä¸­æœ‰ `[SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert`
- ä½†æ²¡æœ‰çœ‹åˆ° `ApplySlaveEscapeNode5` çš„è°ƒç”¨æ—¥å¿—

**å¯èƒ½çš„åŸå› ï¼š**

1. **SelectedPresetOriginNodes è¢« ResetState æ¸…ç©º**
   - `ResetState` ä¸­ä¼šæ¸…ç©º `SelectedPresetOriginNodes`
   - å¦‚æœ `ResetState` åœ¨ `ApplyPresetOrigin` ä¹‹å‰è¢«è°ƒç”¨ï¼ŒèŠ‚ç‚¹é€‰æ‹©ä¼šä¸¢å¤±

2. **ApplyPresetOrigin æ²¡æœ‰è¢«è°ƒç”¨**
   - å¦‚æœ `ApplyPresetOrigin` æ²¡æœ‰è¢«è°ƒç”¨ï¼Œ`ApplySlaveEscapeNode5` ä¹Ÿä¸ä¼šè¢«è°ƒç”¨

---

## ğŸ“‹ ä»£ç æ£€æŸ¥

### 1. ApplyPresetOrigin è°ƒç”¨ä½ç½®

**æ–‡ä»¶ï¼š** `SubModule/OriginSystemCampaignBehavior.cs`  
**è¡Œå·ï¼š** 41

```csharp
if (OriginSystemHelper.IsPresetOrigin && 
    !string.IsNullOrEmpty(OriginSystemHelper.SelectedPresetOriginId))
{
    PresetOriginSystem.ApplyPresetOrigin(OriginSystemHelper.SelectedPresetOriginId);
    Debug.Print($"[OriginSystem] å·²åº”ç”¨é¢„è®¾å‡ºèº«: {OriginSystemHelper.SelectedPresetOriginId}", 0, Debug.DebugColor.Green);
}
```

**é—®é¢˜ï¼š**
- ä½¿ç”¨ `Debug.Print` è€Œä¸æ˜¯ `OriginLog.Info`ï¼Œå¯èƒ½æ—¥å¿—çº§åˆ«ä¸å¤Ÿ
- éœ€è¦æ£€æŸ¥ `IsPresetOrigin` å’Œ `SelectedPresetOriginId` çš„å€¼

### 2. ResetState è°ƒç”¨ä½ç½®

**æ–‡ä»¶ï¼š** `SubModule/OriginSystemHelper.cs`  
**è¡Œå·ï¼š** 42-63

```csharp
public static void ResetState()
{
    var oldPendingDirection = PendingStartDirection;
    var oldPendingSettlementId = PendingStartSettlementId;
    
    IsPresetOrigin = false;  // â† æ¸…ç©ºäº† IsPresetOrigin
    SelectedPresetOriginId = null;  // â† æ¸…ç©ºäº† SelectedPresetOriginId
    SelectedPresetOriginNodes = new Dictionary<string, string>();  // â† æ¸…ç©ºäº†èŠ‚ç‚¹é€‰æ‹©
    
    // ...
}
```

**é—®é¢˜ï¼š**
- `ResetState` æ¸…ç©ºäº†æ‰€æœ‰çŠ¶æ€ï¼ŒåŒ…æ‹¬ `IsPresetOrigin` å’Œ `SelectedPresetOriginId`
- å¦‚æœ `ResetState` åœ¨ `OnSessionLaunched` ä¹‹å‰è¢«è°ƒç”¨ï¼Œä¼šå¯¼è‡´ `ApplyPresetOrigin` æ¡ä»¶ä¸æ»¡è¶³

### 3. ResetState è°ƒç”¨æ—¶æœº

**æ–‡ä»¶ï¼š** `SubModule/OriginSystemSubModule.cs`  
**è¡Œå·ï¼š** 99

```csharp
public override void OnBeforeInitialModuleScreenSetAsRoot(Game game)
{
    OriginSystemHelper.ResetState();  // â† å¯èƒ½è¿‡æ—©è°ƒç”¨
}
```

**é—®é¢˜ï¼š**
- `OnBeforeInitialModuleScreenSetAsRoot` å¯èƒ½åœ¨è§’è‰²åˆ›å»ºå®Œæˆä¹‹å‰è¢«è°ƒç”¨
- å¯¼è‡´ `IsPresetOrigin` å’Œ `SelectedPresetOriginId` è¢«æ¸…ç©º

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå»¶è¿Ÿ ResetState è°ƒç”¨ï¼ˆæ¨èï¼‰

**é—®é¢˜ï¼š** `ResetState` åœ¨è§’è‰²åˆ›å»ºè¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œæ¸…ç©ºäº†çŠ¶æ€

**ä¿®å¤ï¼š** å»¶è¿Ÿ `ResetState` çš„è°ƒç”¨æ—¶æœºï¼Œç¡®ä¿åœ¨ `OnSessionLaunched` ä¹‹åè°ƒç”¨

**æ–‡ä»¶ï¼š** `SubModule/OriginSystemSubModule.cs`

**ä¿®æ”¹ï¼š**
```csharp
// åœ¨ OnBeforeInitialModuleScreenSetAsRoot ä¸­ï¼Œä¸è¦ç«‹å³è°ƒç”¨ ResetState
// æ”¹ä¸ºåœ¨ OnSessionLaunched ä¸­è°ƒç”¨ï¼ˆæ¸¸æˆå¼€å§‹åï¼‰
```

### æ–¹æ¡ˆ2ï¼šåœ¨ ResetState ä¸­ä¿ç•™é¢„è®¾å‡ºèº«çŠ¶æ€

**é—®é¢˜ï¼š** `ResetState` æ¸…ç©ºäº† `IsPresetOrigin` å’Œ `SelectedPresetOriginId`

**ä¿®å¤ï¼š** åœ¨ `ResetState` ä¸­ä¿ç•™é¢„è®¾å‡ºèº«ç›¸å…³çš„çŠ¶æ€

**æ–‡ä»¶ï¼š** `SubModule/OriginSystemHelper.cs`

**ä¿®æ”¹ï¼š**
```csharp
public static void ResetState()
{
    // ä¿ç•™é¢„è®¾å‡ºèº«çŠ¶æ€ï¼Œç›´åˆ° OnSessionLaunched åº”ç”¨å®Œæˆ
    // var oldIsPresetOrigin = IsPresetOrigin;
    // var oldSelectedPresetOriginId = SelectedPresetOriginId;
    
    // åªæ¸…ç©ºéé¢„è®¾å‡ºèº«ç›¸å…³çš„çŠ¶æ€
    // IsPresetOrigin = false;  // â† ä¸è¦æ¸…ç©º
    // SelectedPresetOriginId = null;  // â† ä¸è¦æ¸…ç©º
    // SelectedPresetOriginNodes = new Dictionary<string, string>();  // â† ä¸è¦æ¸…ç©º
    
    // åªæ¸…ç©º Pending ç›¸å…³çš„çŠ¶æ€ï¼ˆå¦‚æœå·²ç»åº”ç”¨å®Œæˆï¼‰
    // ...
}
```

### æ–¹æ¡ˆ3ï¼šåœ¨ OnSessionLaunched ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—

**é—®é¢˜ï¼š** æ— æ³•ç¡®å®š `OnSessionLaunched` æ˜¯å¦è¢«è°ƒç”¨ï¼Œä»¥åŠæ¡ä»¶æ˜¯å¦æ»¡è¶³

**ä¿®å¤ï¼š** æ·»åŠ è¯¦ç»†çš„æ—¥å¿—

**æ–‡ä»¶ï¼š** `SubModule/OriginSystemCampaignBehavior.cs`

**ä¿®æ”¹ï¼š**
```csharp
private void OnSessionLaunched(CampaignGameStarter starter)
{
    OriginLog.Info("[OriginSystem] OnSessionLaunched è¢«è°ƒç”¨");
    OriginLog.Info($"[OriginSystem] IsPresetOrigin={OriginSystemHelper.IsPresetOrigin}");
    OriginLog.Info($"[OriginSystem] SelectedPresetOriginId={OriginSystemHelper.SelectedPresetOriginId ?? "null"}");
    OriginLog.Info($"[OriginSystem] SelectedPresetOriginNodes.Count={OriginSystemHelper.SelectedPresetOriginNodes?.Count ?? 0}");
    
    try
    {
        if (OriginSystemHelper.IsPresetOrigin && 
            !string.IsNullOrEmpty(OriginSystemHelper.SelectedPresetOriginId))
        {
            OriginLog.Info($"[OriginSystem] å¼€å§‹åº”ç”¨é¢„è®¾å‡ºèº«: {OriginSystemHelper.SelectedPresetOriginId}");
            PresetOriginSystem.ApplyPresetOrigin(OriginSystemHelper.SelectedPresetOriginId);
            OriginLog.Info($"[OriginSystem] å·²åº”ç”¨é¢„è®¾å‡ºèº«: {OriginSystemHelper.SelectedPresetOriginId}");
        }
        else
        {
            OriginLog.Warning($"[OriginSystem] æ¡ä»¶ä¸æ»¡è¶³: IsPresetOrigin={OriginSystemHelper.IsPresetOrigin} SelectedPresetOriginId={OriginSystemHelper.SelectedPresetOriginId ?? "null"}");
        }
    }
    catch (Exception ex)
    {
        OriginLog.Error($"[OriginSystem] OnSessionLaunched å¤±è´¥: {ex.Message}");
        OriginLog.Error($"[OriginSystem] StackTrace: {ex.StackTrace}");
    }
}
```

---

## ğŸ“ éªŒè¯æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥ OnSessionLaunched æ˜¯å¦è¢«è°ƒç”¨

**æŸ¥çœ‹æ—¥å¿—ï¼š**
```powershell
Select-String -Path "C:\ProgramData\Mount and Blade II Bannerlord\logs\rgl_log_*.txt" -Pattern "OnSessionLaunched|å·²åº”ç”¨é¢„è®¾å‡ºèº«"
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
[OriginSystem] OnSessionLaunched è¢«è°ƒç”¨
[OriginSystem] IsPresetOrigin=True
[OriginSystem] SelectedPresetOriginId=khuzait_slave_escape
[OriginSystem] å¼€å§‹åº”ç”¨é¢„è®¾å‡ºèº«: khuzait_slave_escape
```

### æ­¥éª¤2ï¼šæ£€æŸ¥ ApplyPresetOrigin æ˜¯å¦è¢«è°ƒç”¨

**æŸ¥çœ‹æ—¥å¿—ï¼š**
```powershell
Select-String -Path "C:\ProgramData\Mount and Blade II Bannerlord\logs\rgl_log_*.txt" -Pattern "ApplyPresetOrigin|\[SlaveEscape\]\[Apply\]"
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
[OriginSystem] å¼€å§‹åº”ç”¨é¢„è®¾å‡ºèº«: khuzait_slave_escape
[SlaveEscape][Apply] ApplySlaveEscapeNode5 è¢«è°ƒç”¨ï¼Œnodes.Count=5
[SlaveEscape][Apply] nodes.ContainsKey('khz_node_ex_slave_direction')=True
[SlaveEscape][Apply] direction=desert
```

### æ­¥éª¤3ï¼šæ£€æŸ¥ ResetState è°ƒç”¨æ—¶æœº

**æŸ¥çœ‹æ—¥å¿—ï¼š**
```powershell
Select-String -Path "C:\ProgramData\Mount and Blade II Bannerlord\logs\rgl_log_*.txt" -Pattern "\[ResetState\]|çŠ¶æ€å·²é‡ç½®|OnBeforeInitialModuleScreenSetAsRoot"
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
[OriginSystem] çŠ¶æ€å·²é‡ç½®
[ResetState] æ¸…ç©ºäº† PendingStartDirection=desert
```

**é—®é¢˜ï¼š**
- å¦‚æœ `[ResetState]` åœ¨ `[OriginSystem] OnSessionLaunched è¢«è°ƒç”¨` ä¹‹å‰å‡ºç°ï¼Œè¯´æ˜ `ResetState` è¿‡æ—©è°ƒç”¨

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ä¿®å¤1ï¼šResetState åŠ ä¿æŠ¤æ¡ä»¶ï¼ˆå·²å®æ–½ âœ…ï¼‰

**æ–‡ä»¶ï¼š** `SubModule/OriginSystemHelper.cs`

**ä¿®æ”¹ï¼š**
```csharp
public static void ResetState()
{
    // æ‰“å°è°ƒç”¨æ ˆï¼ˆå…³é”®ï¼šç¡®è®¤æ˜¯è°è°ƒç”¨çš„ï¼‰
    OriginLog.Warning($"[ResetState] called\n{Environment.StackTrace}");
    
    // å¦‚æœè¿˜åœ¨é¢„è®¾å‡ºèº«æµç¨‹ä¸­ï¼Œç¦æ­¢æ¸…ç©ºå…³é”®å­—æ®µï¼ˆæœ€å°ä¿®å¤æ–¹æ¡ˆ1ï¼‰
    if (IsPresetOrigin || !string.IsNullOrEmpty(SelectedPresetOriginId) || !string.IsNullOrEmpty(PendingStartDirection))
    {
        OriginLog.Warning($"[ResetState] SKIP because preset flow not finished. IsPresetOrigin={IsPresetOrigin} SelectedPresetOriginId={SelectedPresetOriginId ?? "null"} PendingStartDirection={PendingStartDirection ?? "null"}");
        return;
    }
    
    // åŸæ¥çš„æ¸…ç©ºé€»è¾‘...
}
```

**ä¼˜ç‚¹ï¼š**
- æ”¹åŠ¨å°ï¼ˆâ‰¤ 10 è¡Œï¼‰
- ä¸éœ€è¦çŒœå“ªä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¼šè¢«é‡å¤è°ƒç”¨
- ç›´æ¥ä¿è¯"å…³é”®çŠ¶æ€ä¸ä¼šåœ¨æµç¨‹ä¸­é€”è¢«æ¸…æ‰"

### ä¿®å¤2ï¼šOnSessionLaunched æ”¹ç”¨ OriginLogï¼ˆå·²å®æ–½ âœ…ï¼‰

**æ–‡ä»¶ï¼š** `SubModule/OriginSystemCampaignBehavior.cs`

**ä¿®æ”¹ï¼š**
- âœ… æ‰€æœ‰æ—¥å¿—æ”¹ç”¨ `OriginLog.Info`ï¼Œä¸å†ä½¿ç”¨ `Debug.Print`
- âœ… æ·»åŠ è¯¦ç»†çš„çŠ¶æ€æ£€æŸ¥æ—¥å¿—ï¼š
  - `IsPresetOrigin`
  - `SelectedPresetOriginId`
  - `SelectedPresetOriginNodes.Count`
  - `PendingStartDirection`

### ä¿®å¤3ï¼šApplyPresetOrigin å…¥å£æ—¥å¿—ï¼ˆå·²å®æ–½ âœ…ï¼‰

**æ–‡ä»¶ï¼š** `SubModule/PresetOriginSystem.cs`

**ä¿®æ”¹ï¼š**
```csharp
public static void ApplyPresetOrigin(string originId)
{
    // è‡ªè¯æ—¥å¿—ï¼šæ‰“å°"æˆ‘ç¡®å®è¿›æ¥äº†"
    OriginLog.Info($"[ApplyPresetOrigin] originId={originId}");
    // ...
}
```

---

## ğŸ“Š æ—¥å¿—å¯¹æ¯”

### æ­£å¸¸æµç¨‹åº”è¯¥æœ‰çš„æ—¥å¿—

```
[OriginSystem] OnSessionLaunched è¢«è°ƒç”¨
[OriginSystem] IsPresetOrigin=True
[OriginSystem] SelectedPresetOriginId=khuzait_slave_escape
[OriginSystem] SelectedPresetOriginNodes.Count=5
[OriginSystem] å¼€å§‹åº”ç”¨é¢„è®¾å‡ºèº«: khuzait_slave_escape
[SlaveEscape][Apply] ApplySlaveEscapeNode5 è¢«è°ƒç”¨ï¼Œnodes.Count=5
[SlaveEscape][Apply] nodes.ContainsKey('khz_node_ex_slave_direction')=True
[SlaveEscape][Apply] direction=desert
[SlaveEscape][Apply] åœ¨ ApplySlaveEscapeNode5 ä¸­ç›´æ¥è°ƒç”¨ SetSlaveEscapeStartingLocation: desert
[SlaveEscape][Teleport] æ‰¾åˆ° Quyaz åŸå¸‚: Quyaz (town_A1)
[SlaveEscape][Teleport] æ‰¾åˆ° Quyaz æœ€å—ç«¯æ‘åº„: Tasheba (village_A1_1)
[SlaveEscape][Teleport] æ²™æ¼ æ·±å¤„ï¼šåœ¨æ‘åº„ä½ç½®åŸºç¡€ä¸Šå¾€å—åç§» 2.5 å•ä½
[SlaveEscape][Teleport] ä½¿ç”¨ setMethod.Invoke è®¾ç½®ä½ç½®: success=True
```

### å½“å‰å®é™…æ—¥å¿—

```
[OS] [SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert
[OS][WARN] [ResetState] æ¸…ç©ºäº† PendingStartDirection=desert
[OriginSystem] çŠ¶æ€å·²é‡ç½®
[OriginSystem] CampaignBehavior å·²æ·»åŠ 
ï¼ˆæ²¡æœ‰ OnSessionLaunched æ—¥å¿—ï¼‰
ï¼ˆæ²¡æœ‰ ApplyPresetOrigin æ—¥å¿—ï¼‰
ï¼ˆæ²¡æœ‰ [SlaveEscape][Apply] æ—¥å¿—ï¼‰
```

---

## âš ï¸ å…³é”®é—®é¢˜

1. **ResetState è¿‡æ—©è°ƒç”¨**ï¼šåœ¨è§’è‰²åˆ›å»ºè¿‡ç¨‹ä¸­æ¸…ç©ºäº†çŠ¶æ€ âœ… **å·²ä¿®å¤ï¼ˆåŠ ä¿æŠ¤æ¡ä»¶ï¼‰**
2. **OnSessionLaunched å¯èƒ½æ²¡æœ‰è¢«è°ƒç”¨**ï¼šæˆ–è€…è°ƒç”¨æ—¶æ¡ä»¶ä¸æ»¡è¶³ âœ… **å·²ä¿®å¤ï¼ˆæ·»åŠ è¯¦ç»†æ—¥å¿—ï¼‰**
3. **ApplyPresetOrigin æ²¡æœ‰è¢«è°ƒç”¨**ï¼šå¯¼è‡´ `ApplySlaveEscapeNode5` ä¹Ÿæ²¡æœ‰è¢«è°ƒç”¨ âœ… **å·²ä¿®å¤ï¼ˆæ·»åŠ å…¥å£æ—¥å¿—ï¼‰**
4. **èŠ‚ç‚¹é€‰æ‹©å¯èƒ½è¢«æ¸…ç©º**ï¼š`SelectedPresetOriginNodes` åœ¨ `ResetState` ä¸­è¢«æ¸…ç©º âœ… **å·²ä¿®å¤ï¼ˆä¿æŠ¤æ¡ä»¶ï¼‰**

## âš ï¸ é¢å¤–é—®é¢˜ï¼ˆéœ€è¦è¿›ä¸€æ­¥æ’æŸ¥ï¼‰

### é—®é¢˜Aï¼šè·¯ç”± resolved=NULL

**æ—¥å¿—ï¼š**
```
Switch: cur=slave_escape_node5 opt=slave_direction_desert resolved=NULL
```

**è¯´æ˜ï¼š**
- Node5 é€‰æ‹©åï¼Œè·¯ç”±ç³»ç»Ÿè¿”å› `null`
- ç†è®ºä¸Šåº”è¯¥è·³è½¬åˆ° `narrative_parent_menu`ï¼ˆèœå•å®šä¹‰ä¸­å·²è®¾ç½®ï¼‰
- è¿™å¯èƒ½å½±å“è§’è‰²åˆ›å»ºæµç¨‹çš„æ—¶æœº

**å½±å“ï¼š**
- å¯èƒ½å¯¼è‡´ Finalize æ—¶æœºä¸å¯¹
- éœ€è¦ç¡®è®¤è¿™æ˜¯å¦æ˜¯é—®é¢˜çš„ä¸€éƒ¨åˆ†

**æ³¨æ„ï¼š** è¿™ä¸ªé—®é¢˜ä¸ ResetState æ¸…ç©ºçŠ¶æ€æ˜¯**ä¸¤æ¡å¹¶è¡Œçš„é—®é¢˜**ï¼Œéœ€è¦åˆ†å¼€æ’æŸ¥ã€‚

---

**ä¸‹ä¸€æ­¥ï¼š** 
1. âœ… **å·²ä¿®å¤**ï¼šResetState åŠ ä¿æŠ¤æ¡ä»¶
2. âœ… **å·²ä¿®å¤**ï¼šOnSessionLaunched æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼ˆä½¿ç”¨ OriginLogï¼‰
3. âœ… **å·²ä¿®å¤**ï¼šApplyPresetOrigin æ·»åŠ å…¥å£æ—¥å¿—
4. â³ **å¾…æµ‹è¯•**ï¼šé‡æ–°æµ‹è¯•ï¼ŒæŸ¥çœ‹æ–°çš„æ—¥å¿—ï¼š
   - `[ResetState] called` + stacktraceï¼ˆç¡®è®¤è°åœ¨æ¸…çŠ¶æ€ï¼Œæ˜¯å¦è¢«ä¿æŠ¤æ¡ä»¶æ‹¦æˆªï¼‰
   - `[OnSessionLaunched]` å…³é”®çŠ¶æ€å€¼ï¼ˆç¡®è®¤çŠ¶æ€æ˜¯å¦ä¿ç•™ï¼‰
   - `[ApplyPresetOrigin] originId=...`ï¼ˆè¯æ˜ç¡®å®æ‰§è¡Œåˆ°ï¼‰
   - `[SlaveEscape][Apply]` ç›¸å…³æ—¥å¿—ï¼ˆç¡®è®¤ ApplySlaveEscapeNode5 è¢«è°ƒç”¨ï¼‰
   - `[SlaveEscape][Teleport]` ç›¸å…³æ—¥å¿—ï¼ˆç¡®è®¤ä½ç½®è®¾ç½®æˆåŠŸï¼‰

## ğŸ“‹ éªŒè¯æ¸…å•ï¼ˆæµ‹è¯•æ—¶å¿…é¡»æ£€æŸ¥çš„æ—¥å¿—ï¼‰

### å¿…é¡»å‡ºç°çš„æ—¥å¿—ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰

1. **èŠ‚ç‚¹é€‰æ‹©ä¿å­˜**
   ```
   [SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert
   ```

2. **ResetState è°ƒç”¨ï¼ˆå¦‚æœè¢«è°ƒç”¨ï¼‰**
   ```
   [ResetState] called
   [ResetState] SKIP because preset flow not finished  â† åº”è¯¥çœ‹åˆ°è¿™ä¸ª
   ```

3. **OnSessionLaunched è°ƒç”¨**
   ```
   [OnSessionLaunched] called
   [OnSessionLaunched] IsPresetOrigin=True
   [OnSessionLaunched] SelectedPresetOriginId=khuzait_slave_escape
   [OnSessionLaunched] SelectedPresetOriginNodes.Count=5
   [OnSessionLaunched] PendingStartDirection=desert
   ```

4. **ApplyPresetOrigin è°ƒç”¨**
   ```
   [ApplyPresetOrigin] originId=khuzait_slave_escape
   ```

5. **ApplySlaveEscapeNode5 è°ƒç”¨**
   ```
   [SlaveEscape][Apply] ApplySlaveEscapeNode5 è¢«è°ƒç”¨ï¼Œnodes.Count=5
   [SlaveEscape][Apply] nodes.ContainsKey('khz_node_ex_slave_direction')=True
   [SlaveEscape][Apply] direction=desert
   ```

6. **ä½ç½®è®¾ç½®**
   ```
   [SlaveEscape][Teleport] æ‰¾åˆ° Quyaz åŸå¸‚: Quyaz (town_A1)
   [SlaveEscape][Teleport] æ‰¾åˆ° Quyaz æœ€å—ç«¯æ‘åº„: Tasheba (village_A1_1)
   [SlaveEscape][Teleport] æ²™æ¼ æ·±å¤„ï¼šåœ¨æ‘åº„ä½ç½®åŸºç¡€ä¸Šå¾€å—åç§» 2.5 å•ä½
   [SlaveEscape][Teleport] ä½¿ç”¨ setMethod.Invoke è®¾ç½®ä½ç½®: success=True
   ```

### å¦‚æœç¼ºå°‘æŸä¸ªæ—¥å¿—ï¼Œè¯´æ˜çš„é—®é¢˜

- **ç¼ºå°‘ [OnSessionLaunched]ï¼š** OnSessionLaunched æ²¡æœ‰è¢«è°ƒç”¨
- **ç¼ºå°‘ [ApplyPresetOrigin]ï¼š** ApplyPresetOrigin æ²¡æœ‰è¢«è°ƒç”¨ï¼ˆå¯èƒ½æ˜¯æ¡ä»¶ä¸æ»¡è¶³ï¼‰
- **ç¼ºå°‘ [SlaveEscape][Apply]ï¼š** ApplySlaveEscapeNode5 æ²¡æœ‰è¢«è°ƒç”¨ï¼ˆå¯èƒ½æ˜¯èŠ‚ç‚¹é€‰æ‹©è¢«æ¸…ç©ºï¼‰
- **ç¼ºå°‘ [SlaveEscape][Teleport]ï¼š** SetSlaveEscapeStartingLocation æ²¡æœ‰è¢«è°ƒç”¨æˆ–å¤±è´¥

