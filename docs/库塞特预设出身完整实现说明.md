# 库塞特预设出身完整实现说明

## 概述

已完整实现所有10个库塞特预设出身的应用逻辑，包括：
- 根据节点选择动态应用效果
- 初始兵力、技能、关系、金币、食物、马匹等
- 家族等级、贵族状态、雇佣状态等

## 实现位置

**PresetOriginSystem.cs** - 所有预设出身的应用逻辑

## 所有10个预设出身

### 1. 草原叛酋 (rebel_chief)
- **基础效果**：家族等级1级，与库塞特关系-50，初始金币5000
- **Node1效果**：根据被定为叛酋的原因，应用技能和关系
- **Node2效果**：根据战帮组成，添加初始兵力（游牧战士/轻骑/混编）
- **Node3效果**：根据叛酋象征，应用声望/金币/兵力/士气
- **Node4效果**：根据第一步行动，应用技能和资源

### 2. 汗廷旁支贵族 (minor_noble)
- **基础效果**：家族等级3级，贵族家族，与库塞特关系+20，初始金币15000
- **Node1效果**：根据被边缘化原因，应用技能和关系
- **Node2效果**：根据风格（礼法/军功/账本），应用技能、金币、马匹
- **Node3效果**：根据随骑风格，添加初始兵力（贵族随骑/轻骑/混编）
- **Node4效果**：根据政治立场，调整与可汗/大氏族的关系

### 3. 西迁部族首领 (migrant_chief)
- **基础效果**：家族等级2级，与库塞特关系-10，初始金币8000
- **Node1效果**：根据西迁原因，应用技能、关系、食物
- **Node2效果**：根据族人组成，添加初始兵力（战士/家眷/匠人）
- **Node3效果**：根据家当，应用金币、食物、马匹、声望
- **Node4效果**：根据目标，应用技能和资源

### 4. 汗廷军叛逃者 (army_deserter)
- **基础效果**：家族等级1级，与库塞特关系-40，初始金币6000
- **Node1效果**：根据叛逃原因，应用技能、关系、金币
- **Node2效果**：根据旧部组成，添加初始兵力（步兵/骑兵/混编）
- **Node3效果**：根据军需，应用金币或技能
- **Node4效果**：根据生存方式，应用技能和关系

### 5. 草原商路守护者 (trade_protector)
- **基础效果**：家族等级2级，初始金币12000
- **Node1效果**：根据商路类型，应用技能
- **Node2效果**：根据收入来源，应用金币和技能
- **Node3效果**：根据护卫队风格，添加初始兵力
- **Node4效果**：根据对汗廷态度，调整关系

### 6. 迁徙王族 (wandering_prince)
- **基础效果**：家族等级3级，贵族家族，声望+200，与库塞特关系-20，初始金币20000
- **Node1效果**：根据流亡原因，应用技能、声望、金币
- **Node2效果**：根据随从组成，添加初始兵力（贵胄/老兵/混编）
- **Node3效果**：根据面对汗廷策略，应用技能和声望
- **Node4效果**：根据证明王权的方式，应用声望、士气、金币

### 7. 可汗的雇佣战帮 (khans_mercenary)
- **基础效果**：家族等级1级，雇佣兵家族，与库塞特关系+30，初始金币10000
- **Node1效果**：根据被雇佣原因，应用技能和关系
- **Node2效果**：根据战帮风格，添加初始兵力（骑射/标枪/混编）
- **Node3效果**：根据预支类型，应用金币、马匹、食物
- **Node4效果**：根据底线，应用技能和关系

### 8. 逃出沙漠的战奴 (slave_escape)
- **基础效果**：家族等级0级，与阿塞莱关系-60，初始金币3000
- **Node1效果**：根据被奴役前身份，应用技能、金币、马匹
- **Node2效果**：根据被抓原因，应用技能、金币、士气
- **Node3效果**：根据逃亡方式，应用技能
- **Node4效果**：根据带走的东西，应用声望、金币、兵力、士气
- **Node5效果**：根据逃亡方向，应用技能

### 9. 草原自由民 (free_cossack)
- **基础效果**：家族等级1级，与库塞特关系中立，初始金币7000
- **Node1效果**：根据来到草原原因，应用技能和金币
- **Node2效果**：根据生存方式，应用技能和金币
- **Node3效果**：根据战团组成，添加初始兵力（混编/流亡者/精干）
- **Node4效果**：根据对汗廷态度，调整关系和应用技能

### 10. 东方旧部复仇者 (old_guard_avenger)
- **基础效果**：家族等级2级，与库塞特关系-30，初始金币9000
- **Node1效果**：根据旧主类型，应用声望和技能
- **Node2效果**：根据仇敌类型，调整关系和应用技能
- **Node3效果**：根据旧部组成，添加初始兵力（骑射/步兵/混编）
- **Node4效果**：根据开局复仇策略，应用技能、声望、士气

## 实现的功能

### 1. 家族等级设置
- 使用反射设置 `Clan.Tier`
- 支持0-6级

### 2. 贵族状态设置
- 使用反射设置 `Clan.IsNoble`
- 用于汗廷旁支贵族和迁徙王族

### 3. 雇佣状态设置
- 使用反射设置 `Clan.IsMercenary` 和 `Clan.IsMinorFaction`
- 用于可汗的雇佣战帮

### 4. 关系设置
- 使用 `ChangeRelationAction.ApplyPlayerRelation()` 设置与各派系的关系
- 支持与库塞特、阿塞莱等派系的关系调整
- 根据节点选择动态调整关系

### 5. 初始兵力
- 使用 `party.AddElementToMemberRoster()` 添加兵力
- 根据节点选择添加不同类型的兵力
- 支持库塞特所有兵种类型

### 6. 技能加成
- 使用 `hero.HeroDeveloper.AddSkillXp()` 添加技能经验
- 支持所有18种技能
- 根据节点选择动态应用技能加成

### 7. 金币设置
- 使用 `GiveGoldAction.ApplyBetweenCharacters()` 设置金币
- 基础金币 + 节点选择的金币加成

### 8. 食物设置
- 使用 `party.ItemRoster.AddToCounts()` 添加食物
- 根据节点选择添加食物

### 9. 马匹设置
- 使用 `party.ItemRoster.AddToCounts()` 添加马匹
- 根据节点选择添加马匹

### 10. 声望设置
- 使用反射调用 `GainRenownAction.Apply()` 增加声望
- 根据节点选择增加声望

### 11. 士气设置
- 使用 `party.RecentEventsMorale` 调整士气
- 根据节点选择调整士气

## 节点选择映射

系统通过 `OriginSystemHelper.SelectedPresetOriginNodes` 获取节点选择，键名格式：
- `khz_node_<origin>_<node>` = `<choice_id>`

例如：
- `khz_node_rebel_reason` = `refuse_tribute`
- `khz_node_minor_noble_retinue` = `noble`

## 技术细节

### 技能名称映射
配置文件中的技能名称（小写）会映射到游戏中的技能ID（首字母大写）：
- `onehand` → `OneHanded`
- `twohand` → `TwoHanded`
- `riding` → `Riding`
- 等等

### 兵力ID映射
配置文件中的兵力ID直接对应游戏中的 `CharacterObject.StringId`：
- `khuzait_nomad`
- `khuzait_horse_archer`
- `khuzait_light_cavalry`
- 等等

### 错误处理
- 所有操作都有 try-catch 保护
- 失败时记录警告日志，不影响其他效果应用
- 兵力/技能/物品未找到时记录警告，但不中断流程

## 测试建议

1. **测试每个预设出身**：
   - 选择不同的节点选项
   - 验证家族等级是否正确
   - 验证关系是否正确
   - 验证兵力是否正确添加
   - 验证技能是否正确应用
   - 验证金币/食物/马匹是否正确

2. **测试边界情况**：
   - 节点选择为空的情况
   - 兵力ID不存在的情况
   - 技能ID不存在的情况
   - 关系设置失败的情况

3. **测试兼容性**：
   - 与不同版本Bannerlord的兼容性
   - 与其他Mod的兼容性

## 后续扩展

1. **装备系统**：根据节点选择添加初始装备
2. **标记系统**：应用flags（如 `flag_is_suspected`、`flag_has_grudge` 等）
3. **初始位置**：根据出身设置初始位置
4. **雇佣合同**：完善雇佣关系的设置（加入雇佣合同）
5. **特殊事件**：根据出身触发特殊事件

## 日志格式

所有操作都会输出日志，格式：
- `[OriginSystem] 开始应用预设出身: <originId>`
- `[OriginSystem] 添加兵力: <troopId> x<count>`
- `[OriginSystem] 添加技能: <skillName> +<points>`
- `[OriginSystem] 家族等级已设置为: <tier>`
- `[OriginSystem] 预设出身应用完成: <originId>`

## 总结

✅ **已完成**：
- 所有10个预设出身的完整实现
- 根据节点选择动态应用效果
- 初始兵力、技能、关系、金币、食物、马匹等
- 家族等级、贵族状态、雇佣状态等
- 完整的错误处理和日志

🎯 **核心特点**：
- 可汗的雇佣战帮：1级，雇佣关系，与库塞特关系+30
- 汗廷旁支贵族：3级贵族，无封地，与库塞特关系+20
- 逃出沙漠的战奴：0级，与阿塞莱关系-60























































