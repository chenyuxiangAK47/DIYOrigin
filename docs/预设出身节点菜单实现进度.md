# 预设出身节点菜单实现进度

## 当前状态（2025-12-20）

### ✅ 已完成的预设出身节点菜单

1. **草原叛酋（Rebel Chief）** - ✅ 完成
   - Node 1: 你为何被定为叛酋？（4个选项）
   - Node 2: 你的叛乱战帮由谁组成？（3个选项）
   - Node 3: 你带走了什么"叛酋象征"？（4个选项）
   - Node 4: 你第一步要做什么？（3个选项）

2. **汗廷旁支贵族（Minor Noble）** - ✅ 完成
   - Node 1: 你为何被边缘化？（4个选项）
   - Node 2: 你带来的是面子还是刀子？（3个选项）
   - Node 3: 开局随骑是哪一类？（3个选项）
   - Node 4: 你要先靠近谁？（3个选项）

3. **西迁部族首领（Migrant Chief）** - ✅ 完成
   - Node 1: 你为何西迁？（4个选项）
   - Node 2: 你的族人组成？（3个选项）
   - Node 3: 你带走了什么家当？（3个选项）
   - Node 4: 你想定居还是继续游牧？（3个选项）

4. **汗廷军叛逃者（Army Deserter）** - ✅ 完成
   - Node 1: 你为何叛逃？（4个选项）
   - Node 2: 你带走了哪些军中人？（3个选项）
   - Node 3: 你带走了什么军需？（3个选项）
   - Node 4: 你打算洗白还是彻底当军阀？（3个选项）

5. **战奴逃亡（Slave Escape）** - ✅ 完成
   - Node 1: 你被奴役前是什么人？（4个选项）
   - Node 2: 你为什么会被抓？（4个选项）
   - Node 3: 你是怎么逃出来的？（3个选项）
   - Node 4: 逃跑时你带走了什么？（4个选项）
   - Node 5: 你往哪逃？（3个选项）

### ✅ 已完成的预设出身节点菜单（全部完成！）

6. **草原商路守护者（Trade Protector）** - ✅ 完成
   - Node 1: 你守护哪条商路？（3个选项）
   - Node 2: 你靠什么吃饭？（3个选项）
   - Node 3: 你的护卫队是什么风格？（3个选项）
   - Node 4: 你对汗廷的态度？（3个选项）

7. **东方迁徙王族（Wandering Prince）** - ✅ 完成
   - Node 1: 你为何流亡？（4个选项）
   - Node 2: 你带来的旧部是什么？（3个选项，即wandering_prince_subnode）
   - Node 3: 你准备如何面对汗廷？（3个选项）
   - Node 4: 你用什么证明"你是王"？（3个选项）

8. **可汗的雇佣战帮（Khan's Mercenary）** - ✅ 完成
   - Node 1: 你为何被可汗雇佣？（3个选项）
   - Node 2: 你的战帮风格？（3个选项）
   - Node 3: 你拿到的预支是什么？（3个选项）
   - Node 4: 你的底线？（3个选项）

9. **草原自由民（Free Cossack）** - ✅ 完成
   - Node 1: 你为何来到草原？（3个选项）
   - Node 2: 你怎么活下来？（3个选项）
   - Node 3: 你的战团是什么样？（3个选项）
   - Node 4: 你对汗廷是什么态度？（3个选项）

10. **东方旧部复仇者（Old Guard Avenger）** - ✅ 完成
    - Node 1: 你侍奉的旧主是谁？（3个选项）
    - Node 2: 你的仇敌是谁？（3个选项）
    - Node 3: 你带来的旧部是什么样？（3个选项）
    - Node 4: 你如何开局复仇？（3个选项）

## 已完成的代码结构

### 菜单注册（AddParentsMenuPatch）
- ✅ 所有10个预设出身的菜单变量声明已添加
- ✅ 所有菜单的AddNewMenu调用已添加

### OnSelect回调
- ✅ 所有10个预设出身的OnSelect回调已添加（设置PendingMenuSwitch）

## ✅ 所有工作已完成！

所有10个预设出身的节点菜单已全部实现：
- ✅ 草原商路守护者（4个节点）
- ✅ 东方迁徙王族（4个节点，包括Node 1, 2, 3, 4）
- ✅ 可汗的雇佣战帮（4个节点）
- ✅ 草原自由民（4个节点）
- ✅ 东方旧部复仇者（4个节点）

所有菜单方法已实现，菜单链已正确连接，OnSelect回调已正确设置。

## 实现模板参考

可以参考已完成的菜单实现，例如 `CreateRebelChiefNode1Menu`：

```csharp
private static NarrativeMenu CreateXXXNodeXMenu(CharacterCreationManager manager)
{
    var characters = new List<NarrativeMenuCharacter>();
    var menu = new NarrativeMenu(
        "xxx_nodeX",  // StringId
        "xxx_nodeX-1",  // InputMenuId（上一个菜单的StringId）
        "xxx_nodeX+1",  // OutputMenuId（下一个菜单的StringId，最后一个节点用"narrative_parent_menu"）
        new TextObject("菜单标题"),
        new TextObject("菜单描述"),
        characters,
        GetXXXNodeXCharacterArgs
    );
    
    // 添加选项
    menu.AddNarrativeMenuOption(new NarrativeMenuOption(
        "option_id",
        new TextObject("选项标题"),
        new TextObject("选项描述"),
        GetXXXOptionArgs,
        (m) => true,
        (m) => XXXOptionOnSelect(m),
        null
    ));
    
    return menu;
}

// 辅助方法
private static List<NarrativeMenuCharacterArgs> GetXXXNodeXCharacterArgs(...) { return new List<NarrativeMenuCharacterArgs>(); }
private static void GetXXXOptionArgs(NarrativeMenuOptionArgs args) { }
private static void XXXOptionOnSelect(CharacterCreationManager manager)
{
    Debug.Print("[OriginSystem] 用户选择了'XXX-NodeX-选项'", 0, Debug.DebugColor.Green);
    OriginSystemHelper.SelectedPresetOriginNodes["khz_node_xxx"] = "option_value";
    // 如果不是最后一个节点，继续下一个菜单；如果是最后一个节点，设置OriginSelectionDone = true
    if (isLastNode)
        OriginSystemHelper.OriginSelectionDone = true;
    manager.TrySwitchToNextMenu();
}
```

## 注意事项

1. **菜单链连接**：确保每个菜单的InputMenuId和OutputMenuId正确连接
   - Node 1的InputMenuId = "preset_origin_selection"
   - Node X的InputMenuId = "xxx_nodeX-1"
   - Node X的OutputMenuId = "xxx_nodeX+1"（最后一个节点用"narrative_parent_menu"）

2. **节点选择存储**：使用 `OriginSystemHelper.SelectedPresetOriginNodes["khz_node_xxx"] = "value"` 存储选择

3. **最后一个节点**：最后一个节点的OnSelect回调中需要设置 `OriginSystemHelper.OriginSelectionDone = true`

4. **编译命令警告**：⚠️ **不要使用自动编译命令**，会导致自动跳出。手动编译或使用其他方式。

## 文档参考

详细的节点选项和效果定义在 `cursor_.md` 文件中，每个预设出身都有完整的节点文档。

## 下一步行动

1. 按照模板实现剩余的5个预设出身的节点菜单（共约20个菜单方法）
2. 确保所有菜单的InputMenuId和OutputMenuId正确连接
3. 测试编译，修复任何语法错误
4. 在游戏中测试菜单流程

