# Bannerlord 出身系统菜单切换错误和崩溃问题分析

## 问题描述

### 问题1：非预设出身显示预设出身的选项
- **现象**：选择"非预设出身"后，菜单中仍然显示预设出身的选项（如"汗廷旁支贵族"等）
- **预期**：应该显示非预设出身的步骤菜单（文化锚点、社会出身等）

### 问题2：预设出身节点菜单错误
- **现象**：选择不同的预设出身（如"汗廷旁支贵族"、"东方旧部复仇者"等），但显示的节点菜单都是"草原叛酋"的四个选项
- **预期**：每个预设出身应该显示其对应的节点菜单

### 问题3：游戏崩溃
- **现象**：在角色创建过程中，选择节点选项后游戏崩溃
- **崩溃信息**：`Exception occurred inside invoke: OnNextStage`

## 日志分析

从最新的崩溃日志（`rgl_log_26192.txt`）中可以看到：

### 1. 菜单切换失败的警告
```
[OriginSystem] Postfix: 警告：无法设置CurrentMenu（反射失败）
```
这个警告在每次尝试切换预设出身的节点菜单时都会出现，说明反射设置 `CurrentMenu` 失败了。

### 2. 菜单切换流程
```
[OriginSystem] 用户选择了'汗廷旁支贵族'
[OriginSystem] Postfix: 检测到待切换菜单: minor_noble_node1
[OriginSystem] Postfix: 当前菜单: preset_origin_selection, OutputMenuId: narrative_parent_menu
[OriginSystem] Postfix: 目标菜单: minor_noble_node1, InputMenuId: preset_origin_selection
[OriginSystem] Postfix: 警告：无法设置CurrentMenu（反射失败）
[OriginSystem] Postfix: 已切换到菜单: minor_noble_node1
```
虽然日志显示"已切换到菜单"，但实际上由于反射失败，菜单可能并没有真正切换。

### 3. 崩溃时机
```
[OriginSystem] 用户选择了'草原叛酋-Node1-保护部族'
[23:05:54.970] Exception occurred inside invoke: OnNextStage
```
崩溃发生在选择节点选项后，尝试进入下一个阶段时。

## 代码分析

### 问题1：非预设出身菜单显示错误

**可能原因**：
1. 非预设出身的菜单选项可能被错误地添加到了预设出身菜单中
2. 菜单的 `InputMenuId` 和 `OutputMenuId` 配置可能不正确

**相关代码位置**：
- `CreateNonPresetCultureAnchorMenu` (line ~1677)
- `CreatePresetOriginSelectionMenu` (line ~386)

### 问题2：预设出身节点菜单切换失败

**可能原因**：
1. **反射失败**：`SwitchMenuManually` 方法中的反射操作失败，无法设置 `CurrentMenu`
2. **菜单注册问题**：节点菜单可能没有正确注册到 `CharacterCreationManager`
3. **InputMenuId 匹配问题**：所有节点菜单的 `InputMenuId` 都设置为 `"preset_origin_selection"`，可能导致引擎自动切换到第一个匹配的菜单

**相关代码位置**：
- `SwitchMenuManually` (line ~2302)
- `OnNarrativeMenuOptionSelectedPatch.Postfix` (line ~2247)
- 各个节点菜单的创建方法（如 `CreateRebelChiefNode1Menu`, `CreateMinorNobleNode1Menu` 等）

### 问题3：崩溃原因

**可能原因**：
1. **菜单切换失败导致状态不一致**：由于反射失败，菜单没有真正切换，但代码认为已经切换了，导致后续操作失败
2. **OnNextStage 调用时机错误**：在菜单切换失败的情况下，尝试调用 `OnNextStage` 可能导致空引用或状态错误
3. **节点选项的 OnSelect 回调问题**：节点选项的 `OnSelect` 回调中调用了 `manager.TrySwitchToNextMenu()`，但如果菜单链不匹配，可能导致异常

**相关代码位置**：
- 节点选项的 `OnSelect` 回调（如 `RebelReasonProtectTribeOnSelect`）
- `OnNarrativeMenuOptionSelectedPatch` 的 Prefix 和 Postfix

## 技术细节

### 菜单切换机制

当前实现使用 Harmony Patch 拦截 `CharacterCreationManager.OnNarrativeMenuOptionSelected`：

1. **Prefix**：临时修改 `CurrentMenu.OutputMenuId` 以匹配目标菜单的 `InputMenuId`
2. **Postfix**：使用反射直接设置 `CurrentMenu` 并调用 `ModifyMenuCharacters`

### 反射操作

```csharp
private static void SwitchMenuManually(CharacterCreationManager manager, NarrativeMenu targetMenu)
{
    var currentMenuField = typeof(CharacterCreationManager).GetField("CurrentMenu",
        System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
    // ...
    currentMenuField.SetValue(manager, targetMenu);
    // ...
    modifyMethod.Invoke(manager, new object[] { targetMenu });
}
```

**问题**：反射可能失败的原因：
1. 字段名或方法名不正确
2. 访问权限问题
3. 对象状态不正确

## 建议的解决方案

### 方案1：修复反射操作

1. **验证字段和方法是否存在**：在反射前检查字段和方法是否存在
2. **使用更安全的反射方式**：使用 `GetProperty` 或 `GetMethod` 的完整签名
3. **添加异常处理**：捕获反射异常并提供详细的错误信息

### 方案2：使用引擎的菜单切换机制

1. **确保菜单链正确**：确保所有菜单的 `InputMenuId` 和 `OutputMenuId` 正确配置
2. **使用 `TrySwitchToNextMenu`**：依赖引擎的自动切换机制，而不是手动反射
3. **修改 `OutputMenuId`**：在 Prefix 中正确修改 `OutputMenuId`，让引擎自动切换

### 方案3：检查菜单注册

1. **验证菜单是否注册**：确保所有节点菜单都正确注册到 `CharacterCreationManager`
2. **检查菜单ID唯一性**：确保每个菜单的 `StringId` 都是唯一的
3. **验证菜单链**：确保菜单之间的 `InputMenuId` 和 `OutputMenuId` 正确匹配

### 方案4：修复非预设出身菜单

1. **检查菜单选项**：确保非预设出身菜单只包含非预设出身的选项
2. **验证菜单ID**：确保非预设出身菜单的 `StringId` 和 `InputMenuId` 正确
3. **检查菜单切换逻辑**：确保从"出身类型选择"菜单到非预设出身菜单的切换逻辑正确

## 需要的信息

为了进一步诊断问题，需要以下信息：

1. **完整的崩溃堆栈**：查看完整的异常堆栈跟踪
2. **菜单注册日志**：确认所有菜单是否正确注册
3. **反射字段信息**：确认 `CharacterCreationManager` 中 `CurrentMenu` 字段的实际名称和类型
4. **引擎版本**：确认 Bannerlord 的版本号（当前是 v1.3.11.104956）

## 下一步行动

1. **添加更详细的日志**：在关键位置添加日志，记录菜单切换的详细过程
2. **验证反射操作**：检查反射操作是否成功，如果失败，记录失败原因
3. **测试菜单注册**：验证所有菜单是否正确注册
4. **修复非预设出身菜单**：检查并修复非预设出身菜单的选项和切换逻辑

