# 逃奴出生位置修复总结

## 修复内容（按用户要求）

### ✅ 1. 时机修复：使用 OnCharacterCreationFinalized Postfix

**问题**: 之前在 `OnTick` 延迟执行，时机不对，可能被引擎覆盖

**修复**: 
- 创建了 `OnCharacterCreationFinalizedPatch` Harmony Postfix
- 在角色创建 finalize 时直接设置位置（正确时机）
- `OnTick` 改为兜底逻辑（如果 finalize 失败才重试）

**文件**: `SubModule/OriginSystemPatches.cs`

### ✅ 2. 成功标志修复：只有成功才清空 Pending

**问题**: 无论成功失败都清空了 `PendingStartDirection`，导致失败后不会重试

**修复**:
- `SetSlaveEscapeStartingLocation()` 现在返回 `bool success`
- 只有 `success == true` 才清空 `PendingStartDirection` 和 `PendingStartSettlementId`
- 失败时保留状态，允许重试

**文件**: 
- `SubModule/PresetOriginSystem.cs` - `SetSlaveEscapeStartingLocation()` 返回 `bool`
- `SubModule/OriginSystemCampaignBehavior.cs` - `OnTick` 检查返回值
- `SubModule/OriginSystemPatches.cs` - `OnCharacterCreationFinalizedPatch` 检查返回值

### ✅ 3. 移除 TeleportPartyAction 猜测

**问题**: 猜测 `TeleportPartyAction` 的类名和签名，可能根本不存在

**修复**:
- 移除了 `TeleportPartyAction` 的猜测代码
- 直接使用 `Position2D` 属性或反射字段（在 finalize 时机，这是最稳定的方法）

### ✅ 4. 添加城市坐标打印（验证 Y 轴方向）

**问题**: Y 轴方向可能是反的（Y 越小越南 vs Y 越大越南）

**修复**:
- 在查找 settlement 时，先打印所有相关城市的坐标
- 便于运行时验证 Y 轴方向是否正确

**文件**: `SubModule/PresetOriginSystem.cs` - `SetSlaveEscapeStartingLocation()` 中

### ✅ 5. 增强可判定日志

**修复**: 添加了完整的可判定日志：
- `[SlaveEscape][Finalize]` - finalize patch 执行日志
- `[SlaveEscape][Teleport] when=... before=... after=... success=...` - teleport 过程日志
- `[SlaveEscape][Teleport] 城市列表` - 用于验证 Y 轴方向

## 修改的文件

1. **`SubModule/OriginSystemPatches.cs`**
   - 添加了 `OnCharacterCreationFinalizedPatch` Harmony Postfix
   - 在 finalize 时设置出生位置

2. **`SubModule/PresetOriginSystem.cs`**
   - `SetSlaveEscapeStartingLocation()` 改为返回 `bool`
   - 移除了 `TeleportPartyAction` 猜测代码
   - 添加了城市坐标打印
   - 增强了日志

3. **`SubModule/OriginSystemCampaignBehavior.cs`**
   - `OnTick` 改为兜底逻辑
   - 只有成功才清空 Pending

## 编译结果

```
OriginSystemMod -> D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\Modules\OriginSystemMod\bin\Win64_Shipping_Client\OriginSystemMod.dll
```

**0 errors, 0 warnings**

## 预期行为

1. **用户选择方向** → `SaveSlaveEscapeStartingLocation()` 保存 `PendingStartDirection`
2. **角色创建完成** → `OnCharacterCreationFinalizedPatch.Postfix()` 执行
3. **设置位置** → `SetSlaveEscapeStartingLocation()` 返回 `true/false`
4. **如果成功** → 清空 `PendingStartDirection`，完成
5. **如果失败** → 保留 `PendingStartDirection`，`OnTick` 兜底重试

## 调试检查点

运行游戏后，检查以下日志：

1. `[SlaveEscape][Finalize] OnCharacterCreationFinalized Postfix called` - 确认 finalize patch 执行
2. `[SlaveEscape][Teleport] when=OnCharacterCreationFinalized before=(...) after=(...) success=True/False` - 确认 teleport 结果
3. `[SlaveEscape][Teleport] 城市列表` - 验证 Y 轴方向
4. 如果 `success=False`，检查是否有 `[SlaveEscape][Teleport] 开始兜底重试` - 确认兜底逻辑执行




























