# 修复说明：预设出身菜单路由问题

## 问题描述

1. **选择"草原流浪王族"却走"被奴役"路线**：在 `preset_origin_selection` 菜单中选择"迁徙王族"（`khuzait_wandering_prince`）时，游戏却进入了"战奴逃亡"（`slave_escape`）的流程。

2. **没看到私有节点**：选择预设出身选项后，没有进入对应的私有节点菜单（如 `wandering_prince_node1` 或 `slave_escape_node1`）。

## 根本原因

**Prefix 只处理了 `origin_type_selection` 菜单的路由，没有处理 `preset_origin_selection` 菜单的路由**。

当用户在 `preset_origin_selection` 菜单中选择选项时：
- `WanderingPrinceOnSelect` 会设置 `PendingMenuSwitch = "preset_wandering_prince"`
- `SlaveEscapeOnSelect` 会设置 `PendingMenuSwitch = "preset_slave_escape"`
- 但是 Prefix 在 `OnSelect` **之前**执行，所以读不到 `PendingMenuSwitch` 的新值
- Prefix 只检查 `currentMenuId == "origin_type_selection"`，所以不会处理 `preset_origin_selection` 菜单的路由
- 结果：引擎走默认路径，可能随机选择一个菜单，或者走第一个匹配的菜单

## 修复内容

### 1. 扩展 Prefix 逻辑，处理 `preset_origin_selection` 菜单的路由

**修复前**：
```csharp
if (currentMenuId == "origin_type_selection")
{
    // 只处理出身类型选择菜单
    if (optionId == "preset_origin_option")
        targetMenuId = "preset_origin_selection";
    else if (optionId == "non_preset_origin_option")
        targetMenuId = "non_preset_culture_anchor";
}
```

**修复后**：
```csharp
if (currentMenuId == "origin_type_selection")
{
    // 在"出身类型选择"菜单中,根据选项决定目标菜单
    if (optionId == "preset_origin_option")
        targetMenuId = "preset_origin_selection";
    else if (optionId == "non_preset_origin_option")
        targetMenuId = "non_preset_culture_anchor";
}
else if (currentMenuId == "preset_origin_selection")
{
    // 在"预设出身选择"菜单中,根据选项决定目标菜单
    if (optionId == "khuzait_wandering_prince")
        targetMenuId = "wandering_prince_node1";
    else if (optionId == "khuzait_slave_escape")
        targetMenuId = "slave_escape_node1";
    // 可以在这里添加其他预设出身的路由
}
```

### 2. 修复 `wandering_prince_node1` 的 `InputMenuId`

**修复前**：
```csharp
var menu = new NarrativeMenu("wandering_prince_node1", "preset_wandering_prince", ...);
```

**修复后**：
```csharp
var menu = new NarrativeMenu("wandering_prince_node1", "preset_origin_selection", ...);
```

**原因**：`InputMenuId` 应该指向来源菜单的 `StringId`，即 `"preset_origin_selection"`，而不是一个不存在的 `"preset_wandering_prince"` 菜单。

## 菜单路由映射

### `origin_type_selection` 菜单
- `preset_origin_option` → `preset_origin_selection`
- `non_preset_origin_option` → `non_preset_culture_anchor`

### `preset_origin_selection` 菜单
- `khuzait_wandering_prince` → `wandering_prince_node1`
- `khuzait_slave_escape` → `slave_escape_node1`
- 其他预设出身选项：走默认流程（不设置 `targetMenuId`）

## 测试建议

1. **测试"迁徙王族"路由**：
   - 选择"预设出身"
   - 选择"迁徙王族"
   - 应该进入 `wandering_prince_node1` 菜单（"你为何流亡?"）

2. **测试"战奴逃亡"路由**：
   - 选择"预设出身"
   - 选择"战奴逃亡"
   - 应该进入 `slave_escape_node1` 菜单（"你被奴役前是什么人"）

3. **查看日志**：
   - `[OriginSystem] Prefix: 当前菜单=preset_origin_selection, 选项=khuzait_wandering_prince, 目标菜单=wandering_prince_node1`
   - `[OriginSystem] Prefix: 修改 OutputMenuId: narrative_parent_menu -> wandering_prince_node1`
   - `[OriginSystem] TrySwitchToNextMenu Postfix: 切换结果=True, 当前菜单=wandering_prince_node1`

## 代码位置

- **Prefix 路由逻辑**：`OriginSystemPatches.cs` 第 5519-5540 行
- **wandering_prince_node1 菜单定义**：`OriginSystemPatches.cs` 第 1809 行
- **slave_escape_node1 菜单定义**：`OriginSystemPatches.cs` 第 2158-2167 行

## 注意事项

1. **如果添加新的预设出身**：
   - 需要在 Prefix 中添加对应的路由逻辑
   - 确保菜单的 `InputMenuId` 正确指向来源菜单

2. **如果预设出身没有私有节点**：
   - 不设置 `targetMenuId`，让引擎走默认流程
   - 或者设置 `targetMenuId = "narrative_parent_menu"` 走默认父母菜单

3. **调试技巧**：
   - 查看 Prefix 日志，确认路由是否正确
   - 查看 `TrySwitchToNextMenu` Postfix 日志，确认实际切换到了哪个菜单
   - 如果路由失败，检查菜单的 `StringId` 和 `InputMenuId` 是否匹配









































