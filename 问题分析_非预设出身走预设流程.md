# 问题分析：选择非预设出身却走预设流程

## 问题描述

用户在选择"非预设出身"选项时，游戏却进入了预设出身的流程（显示预设出身的选项菜单）。

## 代码流程分析

### 1. 用户选择流程

**"出身类型选择"菜单 (`origin_type_selection`)** 有两个选项：

- **选项 A：预设出身** (`preset_origin_option`)
  - `OnSelect` 回调：`PresetOriginOnSelect`
  - 设置：`OriginSystemHelper.IsPresetOrigin = true`
  - 设置：`OriginSystemHelper.PendingMenuSwitch = "preset_origin_selection"`

- **选项 B：非预设出身** (`non_preset_origin_option`)
  - `OnSelect` 回调：`NonPresetOriginOnSelect`
  - 设置：`OriginSystemHelper.IsPresetOrigin = false`
  - 设置：`OriginSystemHelper.PendingMenuSwitch = "non_preset_culture_anchor"`

### 2. 菜单切换机制

**Harmony Patch: `OnNarrativeMenuOptionSelected` (Prefix)**

```csharp
static void Prefix(CharacterCreationManager __instance, NarrativeMenuOption option)
{
    if (string.IsNullOrEmpty(OriginSystemHelper.PendingMenuSwitch)) return;
    
    var targetMenuId = OriginSystemHelper.PendingMenuSwitch;
    var targetMenu = __instance.GetNarrativeMenuWithId(targetMenuId);
    
    if (targetMenu != null && __instance.CurrentMenu != null)
    {
        // 临时修改 CurrentMenu 的OutputMenuId
        var outputMenuIdField = typeof(NarrativeMenu).GetField("OutputMenuId",
            System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        
        if (outputMenuIdField != null)
        {
            outputMenuIdField.SetValue(__instance.CurrentMenu, targetMenu.InputMenuId);
        }
    }
}
```

**关键逻辑**：
- Prefix 使用 `targetMenu.InputMenuId` 来修改 `CurrentMenu.OutputMenuId`
- 引擎的 `TrySwitchToNextMenu()` 会根据 `CurrentMenu.OutputMenuId` 查找匹配 `InputMenuId` 的菜单

### 3. 菜单定义

**预设出身选择菜单** (`preset_origin_selection`)：
```csharp
var menu = new NarrativeMenu(
    "preset_origin_selection",
    "origin_type_selection",  // InputMenuId: 从"出身类型选择"菜单来
    "narrative_parent_menu",  // OutputMenuId
    ...
);
```

**非预设文化锚点菜单** (`non_preset_culture_anchor`)：
```csharp
var menu = new NarrativeMenu(
    "non_preset_culture_anchor",
    "origin_type_selection",  // InputMenuId: 从"出身类型选择"菜单来
    "non_preset_social_origin",  // OutputMenuId: 下一步:社会出身
    ...
);
```

## 可能的问题原因

### 问题 1：Prefix 逻辑错误

**当前代码**：
```csharp
outputMenuIdField.SetValue(__instance.CurrentMenu, targetMenu.InputMenuId);
```

**问题**：
- `targetMenu.InputMenuId` 是目标菜单的 `InputMenuId`（即 `"origin_type_selection"`）
- 但应该设置的是目标菜单的 `StringId`（即 `"non_preset_culture_anchor"` 或 `"preset_origin_selection"`）
- 因为引擎的 `TrySwitchToNextMenu()` 是根据 `OutputMenuId` 来查找匹配 `InputMenuId` 的菜单

**正确的逻辑应该是**：
```csharp
outputMenuIdField.SetValue(__instance.CurrentMenu, targetMenuId);  // 使用 StringId
```

或者：
```csharp
outputMenuIdField.SetValue(__instance.CurrentMenu, targetMenu.StringId);
```

### 问题 2：菜单查找失败

如果 `GetNarrativeMenuWithId("non_preset_culture_anchor")` 返回 `null`，那么 Prefix 不会修改 `OutputMenuId`，引擎会使用默认的 `OutputMenuId`（即 `"preset_origin_selection"`）。

### 问题 3：菜单注册顺序问题

如果 `non_preset_culture_anchor` 菜单在 `preset_origin_selection` 之后注册，且两者有相同的 `InputMenuId`，引擎可能会选择第一个匹配的菜单。

## 建议的修复方案

### 方案 1：修复 Prefix 逻辑（推荐）

将 Prefix 中的逻辑改为直接使用目标菜单的 `StringId`：

```csharp
outputMenuIdField.SetValue(__instance.CurrentMenu, targetMenuId);  // 直接使用 StringId
```

**原因**：
- `OutputMenuId` 应该存储目标菜单的 `StringId`
- 引擎会根据 `OutputMenuId` 查找匹配 `StringId` 的菜单（不是 `InputMenuId`）

### 方案 2：检查菜单注册

确保 `non_preset_culture_anchor` 菜单已正确注册，且 `StringId` 为 `"non_preset_culture_anchor"`。

### 方案 3：添加调试日志

在 Prefix 中添加更详细的日志，确认：
- `PendingMenuSwitch` 的值
- `targetMenu` 是否找到
- `targetMenu.StringId` 和 `targetMenu.InputMenuId` 的值
- 实际设置的 `OutputMenuId` 值

## 需要确认的信息

1. **引擎的菜单切换机制**：
   - `TrySwitchToNextMenu()` 是根据 `OutputMenuId` 匹配 `StringId` 还是 `InputMenuId`？
   - 如果多个菜单有相同的 `InputMenuId`，引擎如何选择？

2. **当前行为**：
   - 选择非预设出身时，`PendingMenuSwitch` 是否被正确设置为 `"non_preset_culture_anchor"`？
   - `GetNarrativeMenuWithId("non_preset_culture_anchor")` 是否返回非 null？
   - 实际切换到了哪个菜单？

3. **菜单定义**：
   - `non_preset_culture_anchor` 菜单的 `StringId` 是否确实是 `"non_preset_culture_anchor"`？
   - `preset_origin_selection` 菜单的 `StringId` 是否确实是 `"preset_origin_selection"`？

## 代码位置

- **非预设出身选择回调**：`OriginSystemPatches.cs` 第 695-707 行
- **预设出身选择回调**：`OriginSystemPatches.cs` 第 630-642 行
- **菜单切换 Prefix**：`OriginSystemPatches.cs` 第 5514-5566 行
- **非预设文化锚点菜单**：`OriginSystemPatches.cs` 第 4130-4208 行
- **预设出身选择菜单**：`OriginSystemPatches.cs` 第 751-773 行

























































