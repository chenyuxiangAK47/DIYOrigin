# 当前状态总结 - Minor Noble 贵族开局问题

> 更新时间：2024-12-26（最新日志分析）

## 📋 问题描述

**核心问题**：选择 `minor_noble`（小贵族）出身后，`ApplyByJoinToKingdom` 调用失败，导致玩家无法加入库塞特王国。

**最新发现**（2024-12-26）：
- ❌ `ApplyByJoinToKingdom` 方法调用失败（找不到合适的重载）
- ❌ 玩家仍然是独立小势力（`clan.Kingdom = null`）
- ⚠️ Harmony Hooks 未工作（没有 `[HOOK]` 日志）
- ⚠️ DebugBehavior 未工作（没有 `[WATCH]` 日志）

**可能原因**：DLL 没有重新编译或没有正确部署到游戏目录。

## 🔍 已完成的调试工作

### 1. 实现了 Harmony Hooks（抓凶手）

创建了三个 Hook 来追踪所有可能影响贵族状态的操作：

#### Hook 1: `KingdomActionHooks`
- **作用**：追踪所有王国相关的 Action 调用
- **监控的方法**：
  - `ChangeKingdomAction.ApplyByJoinToKingdom`（加入王国）
  - `ChangeKingdomAction.ApplyByJoinFactionAsMercenary`（加入为雇佣兵）
  - `ChangeKingdomAction.ApplyByLeaveKingdomAsMercenary`（离开雇佣兵服务）
- **关键输出**：在 POSTFIX 中检查三个判据是否满足

#### Hook 2: `Hook_Clan_SetIsNoble`
- **作用**：追踪 `Clan.IsNoble` 属性的每次修改
- **关键输出**：如果检测到 `IsNoble: true -> false`，会输出特别警告和调用堆栈

#### Hook 3: `MercenaryActionHooks`
- **作用**：专门追踪雇佣兵相关的操作
- **关键输出**：如果玩家被错误地设置为雇佣兵，会记录警告

### 2. 改进了加入逻辑

#### `JoinKhuzaitAsNoble` 方法改进：
- ✅ 使用编译时调用 `ChangeKingdomAction.ApplyByJoinToKingdom`（不再用反射）
- ✅ 在加入前尝试设置 `Hero.MainHero.Occupation = Occupation.Lord`
- ✅ 使用三个判据验证是否成功：
  1. `Clan.PlayerClan.Kingdom == khuzaitKingdom`
  2. `!Clan.PlayerClan.IsUnderMercenaryService`
  3. `khuzaitKingdom.Clans.Contains(Clan.PlayerClan)`
- ✅ 调整了初始声望值（从 300 改为 1000，符合 Tier 4 要求）

#### `SetClanNoble` 方法：
- ✅ 实现了多重后备机制来设置 `IsNoble`：
  1. 直接设置属性
  2. 通过反射设置私有字段
  3. 使用 `ChangeClanNobleAction`（如果存在）
  4. 间接通过 `SetClanTier` 设置

### 3. 实现了状态检查机制

#### `CheckPlayerClanStatus` 方法：
- ✅ 在 `OnTick` 中定期检查状态
- ✅ 记录三个判据和 `IsLord` 状态
- ✅ 如果状态异常，输出警告

### 4. 创建了日志分析工具

- ✅ `日志分析指南_贵族开局问题.md` - 详细的分析指南
- ✅ `快速查找日志.ps1` - 自动化日志查找和提取脚本

## 🎯 三个判据（真正的封臣标准）

根据 ChatGPT 的建议，**真正的封臣标准**不是 `Clan.IsNoble`，而是：

1. **判据1**：`Clan.PlayerClan.Kingdom == khuzaitKingdom`（在正确的王国）
2. **判据2**：`!Clan.PlayerClan.IsUnderMercenaryService`（不是雇佣兵）
3. **判据3**：`khuzaitKingdom.Clans.Contains(Clan.PlayerClan)`（在王国成员列表中）

**补充判据**：
- `Hero.MainHero.IsLord == true`（主角是领主）
- `Hero.MainHero.Occupation == Occupation.Lord`（职业是领主）

## 📊 问题类型判定表

根据 ChatGPT 的建议，问题可能分为三种情况：

### 情况 A：当场就不成立（Join 根本没落地）

**判断条件**：
- POSTFIX 中：
  - `判据1: Clan.Kingdom == kingdom = False` 或
  - `判据2: !IsUnderMercenaryService = False` 或
  - `判据3: kingdom.Clans.Contains(clan) = False`

**问题类型**：Join 不落地

**可能原因**：
- `ApplyByJoinToKingdom` 调用失败
- 参数错误
- 时机不对（调用时系统还没准备好）

**修复方向**：
- 检查调用时机（延迟到 `OnSessionLaunched` 或更晚）
- 检查参数是否正确
- 检查是否有前置条件未满足

### 情况 B：当场成立，但过一会儿又变回去（被覆盖）

**判断条件**：
- POSTFIX 中三个判据都满足（显示"✅ Join 成功落地"）
- 但之后的状态检查中：
  - `Kingdom` 变回 null 或换国
  - `IsUnderMercenaryService` 变 true
  - `kingdom.Clans` 不包含你了
- 或者 `[HOOK set_IsNoble]` 显示 `IsNoble: true -> false`

**问题类型**：被覆盖

**可能原因**：
- 某个 `CampaignBehavior` 在后续流程中重置了状态
- 系统初始化流程覆盖了状态
- 某个 Action 被错误调用

**修复方向**：
- 查看 `[HOOK set_IsNoble]` 的调用堆栈，找出是谁覆盖的
- 在覆盖操作后重新设置状态
- 或者 Hook 那个覆盖操作，阻止它

### 情况 C：三条一直成立，但 UI/对话仍说"不是贵族"（判据用错）

**判断条件**：
- POSTFIX 中三个判据都满足
- 后续状态检查中三个判据一直满足
- 但 UI 仍然显示不是贵族

**问题类型**：判据用错（你其实已经是封臣，但 UI 不认）

**可能原因**：
- UI 判断走的是 `Hero.IsLord` 或 `Hero.Occupation`
- `IsLord` 没有设置成功
- `Occupation` 没有设置成功

**修复方向**：
- 确保 `Hero.MainHero.SetNewOccupation(Occupation.Lord)` 成功
- 检查 `Hero.MainHero.IsLord` 是否为 true
- 如果 `SetNewOccupation` 不存在，使用反射或找到正确的 API

## 🚀 下一步操作

### ⚠️ 重要更新：已实现监视器和增强的 Harmony Hooks

**新增功能**：
1. ✅ **OriginSystemDebugBehavior**：状态监视器，每 0.5 秒检测状态变化并打印快照
2. ✅ **增强的 Harmony Hooks**：
   - `Hero.SetNewOccupation` / `Hero.set_Occupation` Hook
   - `Clan.StartMercenaryService` / `Clan.EndMercenaryService` Hook
   - 所有 Hook 都输出完整的 `Environment.StackTrace`

**对照实验指南**：请查看 `对照实验指南_手动加入封臣.md`

### 步骤 1：进行对照实验（推荐先做）

**目的**：记录玩家手动加入库塞特成为封臣的完整过程

1. **开新档**，**不要选择 minor_noble 出身**（避免自动加入逻辑干扰）
2. **手动加入库塞特成为封臣**（通过对话选择"成为封臣"）
3. **导出日志**，提取调用链和状态变化时序
4. **填写日志摘要**（参考 `对照实验指南_手动加入封臣.md`）

### 步骤 2：运行游戏并选择 minor_noble 出身（如果对照实验已完成）

1. 启动 Bannerlord
2. 创建新角色
3. 选择 `minor_noble`（小贵族）出身
4. 完成角色创建，进入大地图

### 步骤 2：查找并分析日志

#### 方法 A：使用 PowerShell 脚本（推荐）

```powershell
cd "D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\Modules\OriginSystemMod\文档整理"
.\快速查找日志.ps1
```

脚本会自动：
- 查找日志文件
- 提取四段关键信息
- 显示分析结果

#### 方法 B：手动查找

1. 找到日志文件（通常在）：
   - `%USERPROFILE%\Documents\Mount and Blade II Bannerlord\Logs\rgl_log.txt`
   - 或游戏安装目录下的 `Logs` 文件夹

2. 使用搜索关键词查找四段信息：
   - `[OS] HOOK ApplyByJoinToKingdom POSTFIX`
   - `[OS] StatusCheck`
   - `[OS][WARN] HOOK set_IsNoble`
   - `[OS][WARN] ApplyByJoinFactionAsMercenary`

### 步骤 3：使用判定表判断问题类型

根据日志中的信息，判断是情况 A、B 还是 C：

1. **查看 POSTFIX 日志**：
   - 如果显示"✅ POSTFIX 三个判据都满足，Join 成功落地" → 可能是情况 B 或 C
   - 如果显示"⚠️ POSTFIX 三个判据不满足，Join 未成功落地" → 是情况 A

2. **查看状态检查日志**：
   - 如果后续状态检查中判据都满足 → 可能是情况 C
   - 如果后续状态检查中判据不满足 → 是情况 B

3. **查看 set_IsNoble Hook**：
   - 如果有 `IsNoble: true -> false` → 是情况 B

### 步骤 4：根据判断结果修复

#### 如果是情况 A（Join 不落地）：
- 检查 `JoinKhuzaitAsNoble` 的调用时机
- 延迟到更晚的时机（如 `OnSessionLaunched` 后几秒）
- 检查参数是否正确

#### 如果是情况 B（被覆盖）：
- 查看 `[HOOK set_IsNoble]` 的调用堆栈
- 找出是谁覆盖的
- 在覆盖操作后重新设置状态
- 或者 Hook 那个覆盖操作，阻止它

#### 如果是情况 C（判据用错）：
- 确保 `Hero.MainHero.SetNewOccupation(Occupation.Lord)` 成功
- 检查 `Hero.MainHero.IsLord` 是否为 true
- 如果 `SetNewOccupation` 不存在，找到正确的 API

### 步骤 5：如果无法判断，向 ChatGPT 提问

如果日志信息不足以判断，使用 `问题分析_贵族开局失败_给ChatGPT.md` 中的问题模板向 ChatGPT 提问。

## 📝 关键文件位置

1. **代码文件**：
   - `OriginSystemMod/SubModule/PresetOriginSystem.cs` - 主要逻辑
   - `OriginSystemMod/SubModule/Patches/KingdomActionHooks.cs` - Hook 实现
   - `OriginSystemMod/SubModule/OriginSystemCampaignBehavior.cs` - 状态检查

2. **文档文件**：
   - `OriginSystemMod/文档整理/问题分析/问题分析_贵族开局失败_给ChatGPT.md` - 详细问题分析
   - `OriginSystemMod/文档整理/日志分析指南_贵族开局问题.md` - 日志分析指南
   - `OriginSystemMod/文档整理/当前状态总结_下一步操作.md` - 本文档

3. **工具文件**：
   - `OriginSystemMod/文档整理/快速查找日志.ps1` - 日志查找脚本

## ⚠️ 注意事项

1. **日志格式**：
   - 所有 `OriginLog.Info` 输出都有 `[OS]` 前缀
   - 所有 `OriginLog.Warning` 输出都有 `[OS][WARN]` 前缀
   - 所有 `OriginLog.Error` 输出都有 `[OS][ERR]` 前缀

2. **Hook 可能不工作**：
   - 如果日志中没有 Hook 输出，检查 Harmony 是否正确加载
   - 查看日志中是否有 `[OriginSystem] Harmony PatchAll 完成`

3. **时机问题**：
   - 如果 `ApplyByJoinToKingdom` 在游戏初始化时调用，可能因为系统未准备好而失败
   - 建议延迟到 `OnSessionLaunched` 后几秒

## 🎯 当前状态（2024-12-26 最新）

### ✅ 已完成
- Harmony Hooks 实现
- 加入逻辑改进（改为编译期调用）
- 状态检查机制
- 日志分析工具
- **日志文件位置确认**：`C:\ProgramData\Mount and Blade II Bannerlord\logs\`

### ❌ 最新发现的问题
1. **`ApplyByJoinToKingdom` 调用失败**
   - 日志显示：`未找到ApplyByJoinToKingdom 的合适重载`
   - 但代码中已经改为直接调用（不是反射）
   - **结论**：DLL 可能没有重新编译

2. **Harmony Hooks 未工作**
   - 日志中没有 `[HOOK]` 标签
   - 可能原因：Harmony 加载失败或 patch 失败

3. **DebugBehavior 未工作**
   - 日志中没有 `[WATCH]` 标签
   - 可能原因：Behavior 未加载

### 🎯 下一步行动（立即执行）

1. **重新编译项目**
   - 执行完整的 Rebuild（不是 Build）
   - 确认编译成功，没有错误

2. **确认 DLL 部署**
   - 检查编译输出目录：`OriginSystemMod\bin\Win64_Shipping_Client\OriginSystemMod.dll`
   - 检查游戏 Mod 目录：`D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\Modules\OriginSystemMod\bin\Win64_Shipping_Client\OriginSystemMod.dll`
   - 确认两个文件的修改时间一致（都是最新的）

3. **重新运行游戏并测试**
   - 启动游戏
   - 创建新存档，选择 `minor_noble` 出身
   - 查看新的日志文件：`C:\ProgramData\Mount and Blade II Bannerlord\logs\rgl_log_*.txt`

4. **检查新的日志**
   - 查找 `[OriginSystem] Harmony PatchAll 完成`（确认 Harmony 加载）
   - 查找 `[OriginSystem] DebugBehavior 已添加`（确认 Behavior 加载）
   - 查找 `[HOOK]` 标签的日志（确认 Harmony hooks 工作）
   - 查找 `[WATCH]` 标签的日志（确认 DebugBehavior 工作）
   - 查找 `ApplyByJoinToKingdom` 的调用日志（确认方法被调用）

---

**详细分析**：请查看 `日志分析结果_ApplyByJoinToKingdom失败.md`


