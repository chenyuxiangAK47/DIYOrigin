# 日志分析指南 - 贵族开局问题

> 按照 ChatGPT 建议，使用 Hook 日志来判定问题类型

## 快速定位日志文件

日志文件通常位于：
- `%USERPROFILE%\Documents\Mount and Blade II Bannerlord\Logs\rgl_log.txt`
- 或者游戏安装目录下的 `Logs` 文件夹

## 需要提取的四段信息

### 1. [HOOK ApplyByJoinToKingdom] POSTFIX 那段

**搜索关键词**：
```
[OS] HOOK ApplyByJoinToKingdom POSTFIX
[OS] HOOK-POSTFIX-ApplyByJoinToKingdom
[OS] 判据1: Clan.Kingdom == kingdom
[OS] 判据2: !IsUnderMercenaryService
[OS] 判据3: kingdom.Clans.Contains(clan)
```

**注意**：所有日志都有 `[OS]` 前缀（来自 `OriginLog.Info`）

**关键信息**：
- 三个判据的值（true/false）
- 是否显示"✅ POSTFIX 三个判据都满足，Join 成功落地"
- 或者显示"⚠️ POSTFIX 三个判据不满足，Join 未成功落地"

**示例日志**：
```
[HOOK ApplyByJoinToKingdom] POSTFIX 三个判据检查:
[HOOK ApplyByJoinToKingdom]   判据1: Clan.Kingdom == kingdom = True
[HOOK ApplyByJoinToKingdom]   判据2: !IsUnderMercenaryService = True
[HOOK ApplyByJoinToKingdom]   判据3: kingdom.Clans.Contains(clan) = True
[HOOK ApplyByJoinToKingdom] ✅ POSTFIX 三个判据都满足，Join 成功落地
```

### 2. 之后 1-2 秒内的状态检查

**搜索关键词**：
```
[OS] StatusCheck
[OS] JoinKhuzaitAsNoble.*最终验证
[OS] 判据1|判据2|判据3
[OS] isVassal|isLord
```

**关键信息**：
- 三个判据的值是否变化
- `isVassal` 和 `isLord` 的值
- `IsNoble` 的值

**示例日志**：
```
[StatusCheck] 状态检查:
[StatusCheck]   判据1: Clan.Kingdom == khuzaitKingdom = True
[StatusCheck]   判据2: !IsUnderMercenaryService = True
[StatusCheck]   判据3: kingdom.Clans.Contains(clan) = True
[StatusCheck]   isVassal = True, isLord = True, IsNoble = True
```

### 3. [HOOK set_IsNoble] 的调用记录

**搜索关键词**：
```
[OS][WARN] HOOK set_IsNoble
[OS][WARN] PlayerClan IsNoble
[OS][WARN] 检测到 IsNoble 被从 true 改为 false
```

**关键信息**：
- 是否有 `IsNoble: true -> false` 的记录
- 调用堆栈（看是谁调用的）

**示例日志**：
```
[HOOK set_IsNoble] PlayerClan IsNoble: True -> False
[HOOK set_IsNoble] 调用堆栈:
   at SomeClass.SomeMethod()
   at AnotherClass.AnotherMethod()
```

### 4. 任何雇佣兵相关的 hook

**搜索关键词**：
```
[OS][WARN] ApplyByJoinFactionAsMercenary
[OS][WARN] ApplyByLeaveKingdomAsMercenary
[OS] Mercenary.*HOOK
```

**关键信息**：
- 是否被错误地设置为雇佣兵
- 是否被错误地退出雇佣兵服务

**示例日志**：
```
[HOOK ApplyByJoinFactionAsMercenary] PlayerClan 被调用!
[HOOK ApplyByJoinFactionAsMercenary] 调用堆栈:
```

## 判定表（按照 ChatGPT 建议）

### 情况 A：当场就不成立（Join 根本没落地）

**判断条件**：
- POSTFIX 中：
  - `判据1: Clan.Kingdom == kingdom = False` 或
  - `判据2: !IsUnderMercenaryService = False` 或
  - `判据3: kingdom.Clans.Contains(clan) = False`

**问题类型**：Join 不落地

**可能原因**：
- `ApplyByJoinToKingdom` 调用失败
- 参数错误
- 时机不对（调用时系统还没准备好）

### 情况 B：当场成立，但过一会儿又变回去（被覆盖）

**判断条件**：
- POSTFIX 中三个判据都满足（显示"✅ Join 成功落地"）
- 但之后的状态检查中：
  - `Kingdom` 变回 null 或换国
  - `IsUnderMercenaryService` 变 true
  - `kingdom.Clans` 不包含你了
- 或者 `[HOOK set_IsNoble]` 显示 `IsNoble: true -> false`

**问题类型**：被覆盖

**可能原因**：
- 某个 `CampaignBehavior` 在后续流程中重置了状态
- 系统初始化流程覆盖了状态
- 某个 Action 被错误调用

### 情况 C：三条一直成立，但 UI/对话仍说"不是贵族"（判据用错）

**判断条件**：
- POSTFIX 中三个判据都满足
- 后续状态检查中三个判据一直满足
- 但 UI 仍然显示不是贵族

**问题类型**：判据用错（你其实已经是封臣，但 UI 不认）

**可能原因**：
- UI 判断走的是 `Hero.IsLord` 或 `Hero.Occupation`
- `IsLord` 没有设置成功
- `Occupation` 没有设置成功

## 分析步骤

1. **提取四段日志信息**
   - 使用上面的搜索关键词在日志中查找
   - 复制相关的日志行

2. **使用判定表判断问题类型**
   - 先看 POSTFIX 的三个判据
   - 再看后续状态检查
   - 判断是情况 A、B 还是 C

3. **根据问题类型继续修复**
   - 情况 A：检查 `ApplyByJoinToKingdom` 的调用
   - 情况 B：查看 `[HOOK set_IsNoble]` 的调用堆栈，找出是谁覆盖的
   - 情况 C：检查 `IsLord` 和 `Occupation` 的设置

## 常见问题

### Q: 找不到日志文件？
A: 尝试以下路径：
- `%USERPROFILE%\Documents\Mount and Blade II Bannerlord\Logs\rgl_log.txt`
- 游戏安装目录下的 `Logs` 文件夹
- 使用文件搜索功能搜索 `rgl_log.txt`

### Q: 日志中没有 Hook 输出？
A: 检查：
1. Harmony Hook 是否正确注册（查看是否有 `[OriginSystem] Harmony PatchAll 完成`）
2. Hook 代码是否正确编译
3. 游戏是否使用了最新的 DLL

### Q: 如何确认 Hook 是否工作？
A: 查看日志中是否有：
- `[HOOK ApplyByJoinToKingdom]` 开头的日志
- `[HOOK set_IsNoble]` 开头的日志
- 如果没有，说明 Hook 没有工作

## 下一步

提取日志后，将四段信息提供给 ChatGPT，使用文档中的问题模板提问。


