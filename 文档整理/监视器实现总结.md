# 监视器和 Harmony Hooks 实现总结

> 更新时间：2024-12-19  
> 目标：实现对照实验监视器，记录原版加入封臣的完整调用链

## 📋 已完成的工作

### 第一部分：状态监视器（OriginSystemDebugBehavior）

**文件位置**：`OriginSystemMod/SubModule/OriginSystemDebugBehavior.cs`

**功能**：
- ✅ 每 0.5 秒检测一次关键状态变化
- ✅ 只在状态变化时打印快照（避免刷屏）
- ✅ 记录以下字段的完整状态：
  - `Hero.MainHero.IsLord`
  - `Hero.MainHero.Occupation`
  - `Clan.PlayerClan.Kingdom?.StringId`
  - `Clan.PlayerClan.IsUnderMercenaryService`
  - `Clan.PlayerClan.IsClanTypeMercenary`
  - `Clan.PlayerClan.IsMinorFaction`
  - `Clan.PlayerClan.IsNoble`
  - `Clan.PlayerClan.Tier`
  - `Clan.PlayerClan.Renown`
  - `Clan.PlayerClan.Influence`

**启用方式**：
- 默认已启用（`DebugWatchVassalJoin = true`）
- 可在代码中通过 `OriginSystemDebugBehavior.DebugWatchVassalJoin` 控制

**日志输出示例**：
```
[DEBUG WATCH] 状态快照（状态已变化）
[DEBUG WATCH] Hero.MainHero.IsLord = true
[DEBUG WATCH] Hero.MainHero.Occupation = Lord
[DEBUG WATCH] Clan.PlayerClan.Kingdom?.StringId = kingdom_khuzait
...
```

---

### 第二部分：增强的 Harmony Hooks

**文件位置**：`OriginSystemMod/SubModule/Patches/KingdomActionHooks.cs`

#### 2.1 原有 Hooks（已增强）

**KingdomActionHooks**：
- ✅ 追踪 `ChangeKingdomAction.ApplyByJoinToKingdom`
- ✅ 追踪 `ChangeKingdomAction.ApplyByJoinFactionAsMercenary`
- ✅ 追踪 `ChangeKingdomAction.ApplyByLeaveKingdomAsMercenary`
- ✅ 在 POSTFIX 中检查三个判据是否满足
- ✅ 输出完整的 `Environment.StackTrace`

**Hook_Clan_SetIsNoble**：
- ✅ 追踪 `Clan.set_IsNoble` 的每次修改
- ✅ 检测 `IsNoble: true -> false` 的异常情况
- ✅ 输出调用堆栈和当前状态

**MercenaryActionHooks**：
- ✅ 追踪雇佣兵相关的操作
- ✅ 记录调用前后的完整状态

#### 2.2 新增 Hooks

**HeroOccupationHooks**（新增）：
- ✅ 追踪 `Hero.SetNewOccupation` 方法调用
- ✅ 追踪 `Hero.set_Occupation` 属性设置
- ✅ 只监控 `Hero.MainHero` 的变化
- ✅ 记录调用前后的 `IsLord` 和 `Occupation` 状态
- ✅ 记录 Clan 相关状态（Kingdom、IsNoble、IsUnderMercenaryService）
- ✅ 输出完整的 `Environment.StackTrace`

**ClanMercenaryServiceHooks**（新增）：
- ✅ 追踪 `Clan.StartMercenaryService` 方法调用
- ✅ 追踪 `Clan.EndMercenaryService` 方法调用
- ✅ 只监控 `Clan.PlayerClan` 的变化
- ✅ 记录调用前后的完整状态（Kingdom、IsUnderMercenaryService、IsClanTypeMercenary、IsNoble、IsLord、Occupation）
- ✅ 输出完整的 `Environment.StackTrace`

---

### 第三部分：集成到 SubModule

**文件位置**：`OriginSystemMod/SubModule/OriginSystemSubModule.cs`

**修改内容**：
- ✅ 在 `OnGameStart` 中添加了 `OriginSystemDebugBehavior` 的注册
- ✅ 监视器会在战役开始时自动启用

**代码片段**：
```csharp
protected override void OnGameStart(Game game, IGameStarter gameStarter)
{
    if (game.GameType is Campaign)
    {
        // 添加 CampaignBehavior
        ((CampaignGameStarter)gameStarter).AddBehavior(new OriginSystemCampaignBehavior());
        
        // 添加调试监视器（用于对照实验）
        ((CampaignGameStarter)gameStarter).AddBehavior(new OriginSystemDebugBehavior());
        Debug.Print("[OriginSystem] DebugBehavior 已添加（监视器已启用）", 0, Debug.DebugColor.Green);
    }
}
```

---

### 第四部分：对照实验指南

**文件位置**：`OriginSystemMod/文档整理/对照实验指南_手动加入封臣.md`

**内容**：
- ✅ 详细的实验步骤（开新档、手动加入、导出日志）
- ✅ 日志分析要点（调用顺序、状态变化时序、调用堆栈分析）
- ✅ 关键问题清单（Occupation 何时设置、是否被错误设置为雇佣兵、IsNoble 何时被设置）
- ✅ 日志摘要模板

**实验目的**：
1. 记录原版加入封臣的真实调用链
2. 记录字段变化顺序
3. 找出"成为封臣"的完整流程

---

## 🎯 使用方法

### 步骤 1：进行对照实验

1. **开新档**，**不要选择 minor_noble 出身**（避免自动加入逻辑干扰）
2. **手动加入库塞特成为封臣**（通过对话选择"成为封臣"）
3. **查看日志**，所有关键信息都会被记录

### 步骤 2：分析日志

使用以下关键词搜索日志：

- `[DEBUG WATCH]` - 状态快照
- `[HOOK ApplyByJoinToKingdom]` - 加入王国
- `[HOOK SetNewOccupation]` - 设置 Occupation
- `[HOOK StartMercenaryService]` - 开始雇佣兵服务
- `[HOOK set_IsNoble]` - 设置 IsNoble

### 步骤 3：提取调用链

从日志中提取：
1. **方法调用顺序**：哪些方法被调用，按什么顺序
2. **状态变化时序**：每个时间点的状态值
3. **调用堆栈**：谁调用了这些方法

---

## 📝 下一步

完成对照实验后：

1. **提交日志摘要**：将调用链和状态变化时序整理成摘要
2. **复刻原版调用链**：根据日志摘要，修改自动开局逻辑
3. **验证修复**：使用修复后的自动开局逻辑，再次测试 minor_noble 出身

---

## ⚠️ 注意事项

1. **监视器默认启用**：如果不需要，可以在代码中设置 `DebugWatchVassalJoin = false`
2. **日志量较大**：所有 Hook 都会输出完整堆栈，日志文件可能会很大
3. **性能影响**：监视器每 0.5 秒检查一次状态，对性能影响很小，但建议在调试完成后禁用

---

**所有代码已通过编译检查，可以运行游戏并开始对照实验了！**

