# é€ƒå¥´"æ²™æ¼ æ·±å¤„"çº¿éªŒè¯æŠ¥å‘Š

## éªŒè¯çš„çº¿ï¼š`desert`ï¼ˆèº²è¿›æ²™æ¼ ä¸éƒ¨è½ï¼‰

## âœ… 1. èœå•è·¯ç”±éªŒè¯

### è·¯ç”±é“¾
```
khuzait_slave_escape â†’ slave_escape_node1 â†’ slave_escape_node2 â†’ slave_escape_node3 â†’ slave_escape_node4 â†’ slave_escape_node5
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… `OriginRoutes.Khuzait.cs` ç¬¬23è¡Œï¼š`{ "khuzait_slave_escape", "slave_escape_node1" }`
- âœ… `SlaveEscapeNodes.cs` ç¬¬18è¡Œï¼š`slave_escape_node1` â†’ `slave_escape_node2`
- âœ… `SlaveEscapeNodes.cs` ç¬¬45è¡Œï¼š`slave_escape_node2` â†’ `slave_escape_node3`
- âœ… `SlaveEscapeNodes.cs` ç¬¬72è¡Œï¼š`slave_escape_node3` â†’ `slave_escape_node4`
- âœ… `SlaveEscapeNodes.cs` ç¬¬95è¡Œï¼š`slave_escape_node4` â†’ `slave_escape_node5`
- âœ… `SlaveEscapeNodes.cs` ç¬¬122è¡Œï¼š`slave_escape_node5` â†’ `narrative_parent_menu`

## âœ… 2. Node5 é€‰æ‹©éªŒè¯

### é€‰æ‹©æµç¨‹
**æ–‡ä»¶**ï¼š`SubModule/Menus/Preset/Nodes/SlaveEscapeNodes.cs`

**ç¬¬143-151è¡Œ**ï¼š`SlaveDirectionDesertOnSelect`
```csharp
private static void SlaveDirectionDesertOnSelect(CharacterCreationManager manager) 
{ 
    OriginLog.Info("ç”¨æˆ·é€‰æ‹©æˆ˜å¥´é€ƒäº¡-Node5-ç•™æ²™"); 
    OriginSystemHelper.SelectedPresetOriginNodes["khz_node_ex_slave_direction"] = "desert"; 
    OriginSystemHelper.OriginSelectionDone = true; 
    
    // ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®ï¼šæ²™æ¼ æ·±å¤„ï¼ˆé˜¿å¡è±çš„æ²™æ¼ åŸå¸‚ï¼‰
    SaveSlaveEscapeStartingLocation("desert");
}
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… ä¿å­˜èŠ‚ç‚¹é€‰æ‹©ï¼š`khz_node_ex_slave_direction = "desert"`
- âœ… è°ƒç”¨ `SaveSlaveEscapeStartingLocation("desert")`

**ç¬¬168-183è¡Œ**ï¼š`SaveSlaveEscapeStartingLocation`
```csharp
private static void SaveSlaveEscapeStartingLocation(string direction)
{
    OriginSystemHelper.PendingStartDirection = direction;
    OriginSystemHelper.PendingStartSettlementId = null; // å»¶è¿Ÿåˆ°æ¸¸æˆå¼€å§‹åæŸ¥æ‰¾
    
    OriginLog.Info($"[SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction={direction}");
}
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… ä¿å­˜åˆ° `OriginSystemHelper.PendingStartDirection = "desert"`
- âœ… æ—¥å¿—è¾“å‡ºï¼š`[SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert`

## âœ… 3. å‡ºç”ŸèƒŒæ™¯å®ç°éªŒè¯

### åŸºç¡€æ•ˆæœ
**æ–‡ä»¶**ï¼š`SubModule/PresetOriginSystem.cs`

**ç¬¬1135-1154è¡Œ**ï¼š`ApplySlaveEscapeOrigin`
```csharp
private static void ApplySlaveEscapeOrigin(Hero hero, Clan clan, MobileParty party)
{
    SetClanTier(clan, 0);  // âœ… å®¶æ—ç­‰çº§ 0

    var aseraiKingdom = FindKingdom("kingdom_aserai");
    if (aseraiKingdom != null)
    {
        ChangeRelationAction.ApplyPlayerRelation(aseraiKingdom.Leader, -60);  // âœ… ä¸é˜¿å¡è±æ•Œå¯¹ -60
    }

    var selectedNodes = OriginSystemHelper.SelectedPresetOriginNodes;
    
    ApplySlaveEscapeNode1(hero, selectedNodes);  // âœ… Node1 æŠ€èƒ½
    ApplySlaveEscapeNode2(hero, selectedNodes);  // âœ… Node2 æŠ€èƒ½
    ApplySlaveEscapeNode3(hero, selectedNodes);  // âœ… Node3 æŠ€èƒ½/ç‰¹æ€§
    ApplySlaveEscapeNode4(hero, party, selectedNodes);  // âœ… Node4 è£…å¤‡/éƒ¨é˜Ÿ/é‡‘å¸
    ApplySlaveEscapeNode5(hero, selectedNodes);  // âœ… Node5 æŠ€èƒ½

    GiveGoldAction.ApplyBetweenCharacters(null, hero, 3000, false);  // âœ… åŸºç¡€é‡‘å¸ 3000
}
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… å®¶æ—ç­‰çº§è®¾ç½®ä¸º 0
- âœ… ä¸é˜¿å¡è±å…³ç³» -60ï¼ˆæ•Œå¯¹ï¼‰
- âœ… åŸºç¡€é‡‘å¸ 3000
- âœ… æ‰€æœ‰ Node1-5 çš„æ•ˆæœéƒ½ä¼šåº”ç”¨

### Node5 ç‰¹å®šæ•ˆæœï¼ˆdesertï¼‰
**ç¬¬1302-1306è¡Œ**ï¼š`ApplySlaveEscapeNode5` - `desert` åˆ†æ”¯
```csharp
case "desert":
    AddSkill(hero, "steward", 2);  // âœ… ç®¡ç†+2
    AddSkill(hero, "scouting", 3);  // âœ… ä¾¦å¯Ÿ+3
    OriginLog.Info("[SlaveEscape] é€‰æ‹©æ²™æ¼ æ·±å¤„ï¼Œå‡ºç”Ÿä½ç½®å·²åœ¨ node ä¸­ä¿å­˜");
    break;
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… ç®¡ç†æŠ€èƒ½ +2
- âœ… ä¾¦å¯ŸæŠ€èƒ½ +3
- âœ… æ—¥å¿—è¾“å‡ºç¡®è®¤

## âœ… 4. å‡ºç”Ÿä½ç½®å®ç°éªŒè¯

### å»¶è¿Ÿæ‰§è¡Œæµç¨‹
**æ–‡ä»¶**ï¼š`SubModule/OriginSystemPatches.cs`

**ç¬¬356-416è¡Œ**ï¼š`OnCharacterCreationFinalizedPatch.Postfix`
```csharp
[HarmonyPostfix]
static void Postfix()
{
    OriginLog.Info("[SlaveEscape][Finalize] OnCharacterCreationFinalized Postfix called");

    // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„å‡ºç”Ÿä½ç½®è®¾ç½®
    if (string.IsNullOrEmpty(OriginSystemHelper.PendingStartDirection))
    {
        OriginLog.Info("[SlaveEscape][Finalize] æ— å¾…å¤„ç†çš„å‡ºç”Ÿä½ç½®è®¾ç½®");
        return;
    }

    var direction = OriginSystemHelper.PendingStartDirection;
    OriginLog.Info($"[SlaveEscape][Finalize] å¼€å§‹è®¾ç½®å‡ºç”Ÿä½ç½®: direction={direction}");

    // æ£€æŸ¥å¿…è¦å¯¹è±¡æ˜¯å¦å­˜åœ¨
    if (Hero.MainHero == null || MobileParty.MainParty == null || Campaign.Current == null)
    {
        OriginLog.Warning("[SlaveEscape][Finalize] å¯¹è±¡ä¸ºç©ºï¼Œå»¶è¿Ÿåˆ° OnTick");
        return;
    }

    // æ‰§è¡Œ teleport
    bool success = PresetOriginSystem.SetSlaveEscapeStartingLocation(
        MobileParty.MainParty,
        direction,
        OriginSystemHelper.PendingStartSettlementId
    );

    if (success)
    {
        // åªæœ‰æˆåŠŸæ‰æ¸…ç©º Pending
        OriginSystemHelper.PendingStartDirection = null;
        OriginSystemHelper.PendingStartSettlementId = null;
        OriginLog.Info("[SlaveEscape][Finalize] å‡ºç”Ÿä½ç½®è®¾ç½®æˆåŠŸï¼Œå·²æ¸…ç©º Pending");
    }
    else
    {
        OriginLog.Warning("[SlaveEscape][Finalize] å‡ºç”Ÿä½ç½®è®¾ç½®å¤±è´¥ï¼Œä¿ç•™ Pending ä»¥ä¾¿ OnTick é‡è¯•");
    }
}
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… åœ¨è§’è‰²åˆ›å»º finalize æ—¶æ‰§è¡Œï¼ˆæ­£ç¡®æ—¶æœºï¼‰
- âœ… æ£€æŸ¥ `PendingStartDirection` æ˜¯å¦ä¸º "desert"
- âœ… è°ƒç”¨ `SetSlaveEscapeStartingLocation` è®¾ç½®ä½ç½®
- âœ… åªæœ‰æˆåŠŸæ‰æ¸…ç©º Pending

### ä½ç½®è®¾ç½®å®ç°
**æ–‡ä»¶**ï¼š`SubModule/PresetOriginSystem.cs`

**ç¬¬1319-1515è¡Œ**ï¼š`SetSlaveEscapeStartingLocation`

**desert åˆ†æ”¯ï¼ˆç¬¬1337-1377è¡Œï¼‰**ï¼š
```csharp
if (direction == "desert")
{
    // âœ… å…ˆæ‰“å°æ‰€æœ‰é˜¿å¡è±åŸå¸‚ç”¨äºéªŒè¯ Y è½´æ–¹å‘
    var allAseraiTowns = Campaign.Current.Settlements?
        .Where(s => s.IsTown && s.Culture?.StringId == "aserai")
        .ToList();
    
    if (allAseraiTowns != null && allAseraiTowns.Any())
    {
        OriginLog.Info("[SlaveEscape][Teleport] é˜¿å¡è±åŸå¸‚åˆ—è¡¨ï¼ˆç”¨äºéªŒè¯ Y è½´æ–¹å‘ï¼‰:");
        foreach (var town in allAseraiTowns.OrderBy(s => s.Position.Y))
        {
            var pos = town.Position;
            OriginLog.Info($"  - {town.Name} ({town.StringId}) Pos=({pos.X:F2},{pos.Y:F2})");
        }
    }

    // âœ… å¯»æ‰¾é˜¿å¡è±çš„æ²™æ¼ åŸå¸‚ï¼ˆY æœ€å¤§ = æœ€å—ï¼‰
    var aseraiSettlements = Campaign.Current?.Settlements?
        .Where(s => s.IsTown && s.Culture?.StringId == "aserai")
        .OrderByDescending(s => s.Position.Y) // Yè½´è¶Šå¤§è¶Šé å—ï¼ˆéœ€è¦éªŒè¯ï¼‰
        .FirstOrDefault();

    if (aseraiSettlements != null)
    {
        targetSettlement = aseraiSettlements;
        OriginLog.Info($"[SlaveEscape][Teleport] æ‰¾åˆ°æ²™æ¼ æ·±å¤„åŸå¸‚: {targetSettlement.Name} ({targetSettlement.StringId})");
    }
    else
    {
        // âœ… å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•é€šè¿‡IDæŸ¥æ‰¾
        targetSettlement = Campaign.Current?.Settlements?.FirstOrDefault(s => 
            s.StringId == "town_AN1" || // Quyaz
            s.StringId == "town_AN2" || // Sanala
            s.StringId == "town_AN3");  // Husn Fulq
    }
}
```

**ä½ç½®è®¾ç½®ï¼ˆç¬¬1441-1482è¡Œï¼‰**ï¼š
```csharp
// âœ… è®°å½• teleport å‰çš„çŠ¶æ€
Vec2 beforePos = Vec2.Invalid;
var beforePosProp = typeof(MobileParty).GetProperty("Position2D", ...);
if (beforePosProp != null)
{
    beforePos = (Vec2)beforePosProp.GetValue(party);
}
OriginLog.Info($"[SlaveEscape][Teleport] when=OnCharacterCreationFinalized before=({beforePos.X:F2},{beforePos.Y:F2}) targetSettlement={targetSettlement.StringId} targetName={targetSettlement.Name}");

// âœ… ç›´æ¥è®¾ç½® Position2Dï¼ˆåœ¨ finalize æ—¶æœºï¼Œè¿™æ˜¯æœ€ç¨³å®šçš„æ–¹æ³•ï¼‰
bool teleportSuccess = false;
try
{
    var positionProperty = typeof(MobileParty).GetProperty("Position2D", BindingFlags.Public | BindingFlags.Instance);
    if (positionProperty != null && positionProperty.CanWrite)
    {
        positionProperty.SetValue(party, position);
        teleportSuccess = true;
        OriginLog.Info($"[SlaveEscape][Teleport] ä½¿ç”¨ Position2D å±æ€§è®¾ç½®ä½ç½®: success=True");
    }
    else
    {
        // âœ… å¦‚æœå±æ€§ä¸å¯å†™ï¼Œå°è¯•åå°„å­—æ®µ
        var positionField = typeof(MobileParty).GetField("_position2D", BindingFlags.NonPublic | BindingFlags.Instance);
        if (positionField != null)
        {
            positionField.SetValue(party, position);
            teleportSuccess = true;
            OriginLog.Info($"[SlaveEscape][Teleport] ä½¿ç”¨åå°„å­—æ®µè®¾ç½®ä½ç½®: success=True");
        }
    }
}
catch (Exception ex)
{
    OriginLog.Error($"[SlaveEscape][Teleport] è®¾ç½®ä½ç½®æ—¶å¼‚å¸¸: {ex.Message} success=False");
}

// âœ… éªŒè¯è®¾ç½®æ˜¯å¦æˆåŠŸ
Vec2 afterPos = Vec2.Invalid;
if (beforePosProp != null)
{
    afterPos = (Vec2)beforePosProp.GetValue(party);
}
OriginLog.Info($"[SlaveEscape][Teleport] after=({afterPos.X:F2},{afterPos.Y:F2}) success={teleportSuccess}");

return teleportSuccess;
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… æ‰“å°æ‰€æœ‰é˜¿å¡è±åŸå¸‚åæ ‡ï¼ˆç”¨äºéªŒè¯ Y è½´æ–¹å‘ï¼‰
- âœ… æŸ¥æ‰¾é˜¿å¡è±åŸå¸‚ï¼ˆY æœ€å¤§ = æœ€å—ï¼Œéœ€è¦è¿è¡Œæ—¶éªŒè¯ï¼‰
- âœ… å¦‚æœæ‰¾ä¸åˆ°ï¼Œfallback åˆ° ID æŸ¥æ‰¾ï¼ˆtown_AN1/AN2/AN3ï¼‰
- âœ… è®°å½• teleport å‰çš„ä½ç½®
- âœ… ä½¿ç”¨ Position2D å±æ€§æˆ–åå°„å­—æ®µè®¾ç½®ä½ç½®
- âœ… è®°å½• teleport åçš„ä½ç½®
- âœ… è¿”å› bool è¡¨ç¤ºæˆåŠŸ/å¤±è´¥

## âœ… 5. å…œåº•é€»è¾‘éªŒè¯

**æ–‡ä»¶**ï¼š`SubModule/OriginSystemCampaignBehavior.cs`

**ç¬¬75-126è¡Œ**ï¼š`OnTick` å…œåº•é€»è¾‘
```csharp
// å…œåº•é€»è¾‘ï¼šå¦‚æœ OnCharacterCreationFinalized å¤±è´¥ï¼Œåœ¨ OnTick ä¸­é‡è¯•
if (!_hasSetSlaveEscapePosition && 
    !string.IsNullOrEmpty(OriginSystemHelper.PendingStartDirection))
{
    _teleportDelay += dt;
    
    if (_teleportDelay >= TELEPORT_DELAY_SECONDS)
    {
        bool success = PresetOriginSystem.SetSlaveEscapeStartingLocation(
            MobileParty.MainParty, 
            direction, 
            settlementId
        );

        if (success)
        {
            _hasSetSlaveEscapePosition = true;
            OriginSystemHelper.PendingStartDirection = null;
            OriginSystemHelper.PendingStartSettlementId = null;
            OriginLog.Info("[SlaveEscape][Teleport] å…œåº•é‡è¯•æˆåŠŸï¼Œå·²æ¸…ç©º Pending");
        }
        else
        {
            OriginLog.Warning("[SlaveEscape][Teleport] å…œåº•é‡è¯•å¤±è´¥ï¼Œä¿ç•™ Pending ç»§ç»­é‡è¯•");
        }
    }
}
```

**éªŒè¯ç»“æœ**ï¼š
- âœ… å¦‚æœ finalize å¤±è´¥ï¼Œåœ¨ OnTick ä¸­é‡è¯•
- âœ… å»¶è¿Ÿ 1 ç§’ç¡®ä¿åœ°å›¾å’Œé˜Ÿä¼å·²åˆå§‹åŒ–
- âœ… åªæœ‰æˆåŠŸæ‰æ¸…ç©º Pending

## ğŸ“‹ é¢„æœŸæ—¥å¿—åºåˆ—

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—åºåˆ—ï¼š

```
[OS] ç”¨æˆ·é€‰æ‹©æˆ˜å¥´é€ƒäº¡-Node5-ç•™æ²™
[OS] [SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert
[OriginSystem] å·²åº”ç”¨é¢„è®¾å‡ºèº«: slave_escape
[OS] [SlaveEscape][Apply] direction=desert campaign=True mainHero=True mainParty=True pos=(...)
[OS] [SlaveEscape] é€‰æ‹©æ²™æ¼ æ·±å¤„ï¼Œå‡ºç”Ÿä½ç½®å·²åœ¨ node ä¸­ä¿å­˜
[OS] [SlaveEscape][Finalize] OnCharacterCreationFinalized Postfix called
[OS] [SlaveEscape][Finalize] å¼€å§‹è®¾ç½®å‡ºç”Ÿä½ç½®: direction=desert
[OS] [SlaveEscape][Teleport] é˜¿å¡è±åŸå¸‚åˆ—è¡¨ï¼ˆç”¨äºéªŒè¯ Y è½´æ–¹å‘ï¼‰:
  - Quyaz (town_AN1) Pos=(450.00,650.00)
  - Sanala (town_AN2) Pos=(420.00,620.00)
  ...
[OS] [SlaveEscape][Teleport] æ‰¾åˆ°æ²™æ¼ æ·±å¤„åŸå¸‚: Quyaz (town_AN1)
[OS] [SlaveEscape][Teleport] when=OnCharacterCreationFinalized before=(100.00,200.00) targetSettlement=town_AN1 targetName=Quyaz
[OS] [SlaveEscape][Teleport] ä½¿ç”¨ Position2D å±æ€§è®¾ç½®ä½ç½®: success=True
[OS] [SlaveEscape][Teleport] after=(450.00,650.00) success=True
[OS] [SlaveEscape][Finalize] å‡ºç”Ÿä½ç½®è®¾ç½®æˆåŠŸï¼Œå·²æ¸…ç©º Pending
```

## âš ï¸ é™æ€èµ°æŸ¥ç»“è®ºï¼ˆä»£ç é€»è¾‘å®Œæ•´ï¼Œä½†éœ€è¿è¡Œæ—¶éªŒè¯ï¼‰

**"æ²™æ¼ æ·±å¤„"ï¼ˆdesertï¼‰çº¿é™æ€èµ°æŸ¥ç»“æœ**ï¼š

1. âœ… **èœå•è·¯ç”±**ï¼šä»£ç é€»è¾‘å®Œæ•´ï¼Œä» `khuzait_slave_escape` åˆ° `slave_escape_node5`
2. âœ… **Node5 é€‰æ‹©**ï¼šä»£ç é€»è¾‘æ­£ç¡®ï¼Œä¼šä¿å­˜ `direction="desert"` åˆ° `PendingStartDirection`
3. âœ… **å‡ºç”ŸèƒŒæ™¯**ï¼šä»£ç é€»è¾‘å®Œæ•´
   - âœ… ä¸é˜¿å¡è±æ•Œå¯¹ï¼ˆ-60å…³ç³»ï¼‰
   - âœ… åŸºç¡€é‡‘å¸ 3000
   - âœ… Node5 æŠ€èƒ½ï¼šç®¡ç†+2ï¼Œä¾¦å¯Ÿ+3
   - âœ… æ‰€æœ‰ Node1-5 çš„æ•ˆæœéƒ½ä¼šåº”ç”¨
4. âœ… **å‡ºç”Ÿä½ç½®**ï¼šä»£ç é€»è¾‘å®Œæ•´
   - âœ… åœ¨ `OnCharacterCreationFinalized` æ—¶è®¾ç½®ï¼ˆæ­£ç¡®æ—¶æœºï¼‰
   - âœ… æŸ¥æ‰¾é˜¿å¡è±åŸå¸‚ï¼ˆY æœ€å¤§ = æœ€å—ï¼Œéœ€è¿è¡Œæ—¶éªŒè¯ï¼‰
   - âœ… æ‰“å°åŸå¸‚åæ ‡åˆ—è¡¨ï¼ˆç”¨äºéªŒè¯ Y è½´æ–¹å‘ï¼‰
   - âœ… è®¾ç½®ä½ç½®å¹¶éªŒè¯æˆåŠŸ
   - âœ… å…œåº•é€»è¾‘ï¼ˆå¦‚æœ finalize å¤±è´¥ï¼ŒOnTick é‡è¯•ï¼‰

**âš ï¸ é‡è¦ï¼šè¿™åªæ˜¯é™æ€ä»£ç èµ°æŸ¥ï¼Œä»¥ä¸‹å…³é”®ç‚¹å¿…é¡»åœ¨è¿è¡Œæ—¶éªŒè¯æ‰èƒ½ç¡®è®¤å®ç°ç”Ÿæ•ˆã€‚**

---

## ğŸ” è¿è¡Œæ—¶éªŒè¯è¦æ±‚ï¼ˆå¿…é¡»æä¾›çœŸå®æ—¥å¿—ï¼‰

### 1. Patch æ˜¯å¦è¢«è°ƒç”¨ï¼ˆæœ€å…³é”®ï¼‰

**éªŒè¯ç‚¹**ï¼šHarmony Postfix æ˜¯å¦çœŸçš„è¢«æ‰§è¡Œ

**å¿…é¡»æä¾›çš„æ—¥å¿—**ï¼š
```
[OS] [SlaveEscape][Finalize] OnCharacterCreationFinalized Postfix called
```

**å¦‚æœçœ‹ä¸åˆ°è¿™æ¡æ—¥å¿—**ï¼š
- âŒ Patch å¯èƒ½æœªæ³¨å†Œï¼ˆHarmony æœªæ‰¾åˆ°ç›®æ ‡æ–¹æ³•ï¼‰
- âŒ ç›®æ ‡æ–¹æ³•ç­¾åä¸å¯¹ï¼ˆ`OnCharacterCreationFinalized` vs `FinalizeCharacterCreation`ï¼‰
- âŒ Patch æ³¨å†Œæ—¶æœºä¸å¯¹ï¼ˆåœ¨ Campaign å¯åŠ¨å‰æ³¨å†Œå¤±è´¥ï¼‰

**éªŒè¯æ–¹æ³•**ï¼šè¿è¡Œæ¸¸æˆï¼Œé€‰æ‹©é€ƒå¥´ â†’ é€‰æ‹©"æ²™æ¼ æ·±å¤„"ï¼ŒæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶

---

### 2. PendingStartDirection ç”Ÿå‘½å‘¨æœŸéªŒè¯ï¼ˆé˜²æ­¢è¢«æ¸…ç©ºï¼‰

**éªŒè¯ç‚¹**ï¼š`PendingStartDirection` ä» Node5 OnSelect åˆ° Finalize Postfix æ˜¯å¦ä¸€ç›´å­˜åœ¨

**å¿…é¡»æä¾›çš„æ—¥å¿—åºåˆ—**ï¼š
```
[OS] ç”¨æˆ·é€‰æ‹©æˆ˜å¥´é€ƒäº¡-Node5-ç•™æ²™
[OS] [SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert
[OS] [SlaveEscape][Finalize] OnCharacterCreationFinalized Postfix called
[OS] [SlaveEscape][Finalize] å¼€å§‹è®¾ç½®å‡ºç”Ÿä½ç½®: direction=desert
```

**å¦‚æœ Node5 æ—¥å¿—åæ²¡æœ‰ Finalize æ—¥å¿—**ï¼š
- âŒ `ResetState()` å¯èƒ½åœ¨æŸä¸ªæ—¶æœºè¢«è°ƒç”¨ï¼Œæ¸…ç©ºäº† `PendingStartDirection`
- âŒ éœ€è¦æ£€æŸ¥æ‰€æœ‰è°ƒç”¨ `ResetState()` çš„åœ°æ–¹

**éªŒè¯æ–¹æ³•**ï¼šåœ¨ `ResetState()` ä¸­æ·»åŠ æ—¥å¿—ï¼š
```csharp
OriginLog.Warning($"[ResetState] è¢«è°ƒç”¨ï¼Œæ¸…ç©º PendingStartDirection={OriginSystemHelper.PendingStartDirection}");
```

---

### 3. Position2D Setter æ˜¯å¦çœŸçš„ç”Ÿæ•ˆï¼ˆé˜²æ­¢é™é»˜å¤±è´¥ï¼‰

**éªŒè¯ç‚¹**ï¼š`Position2D` å±æ€§æ˜¯å¦çœŸçš„è¢«è®¾ç½®æˆåŠŸ

**å½“å‰ä»£ç é—®é¢˜**ï¼š
- åªæ£€æŸ¥äº† `positionProperty.CanWrite`ï¼Œä½† Bannerlord çš„ setter å¯èƒ½æ˜¯ non-public
- `SetValue()` å¯èƒ½é™é»˜å¤±è´¥ï¼ˆä¸æŠ›å¼‚å¸¸ä½†ä¹Ÿä¸ç”Ÿæ•ˆï¼‰

**å¿…é¡»è¡¥å……çš„æ—¥å¿—**ï¼š
```csharp
// åœ¨ SetSlaveEscapeStartingLocation ä¸­æ·»åŠ 
var positionProperty = typeof(MobileParty).GetProperty("Position2D", BindingFlags.Public | BindingFlags.Instance);
if (positionProperty != null)
{
    var setMethod = positionProperty.GetSetMethod(true); // true = åŒ…æ‹¬ non-public
    OriginLog.Info($"[SlaveEscape][Teleport] Position2D setter exists={setMethod != null} isPublic={setMethod?.IsPublic ?? false}");
    
    if (setMethod != null)
    {
        setMethod.Invoke(party, new object[] { position });
        OriginLog.Info($"[SlaveEscape][Teleport] ä½¿ç”¨ setMethod.Invoke è®¾ç½®ä½ç½®: success=True");
    }
    else
    {
        OriginLog.Warning($"[SlaveEscape][Teleport] Position2D setter ä¸å­˜åœ¨ï¼Œå°è¯•åå°„å­—æ®µ");
    }
}
```

**å¿…é¡»æä¾›çš„æ—¥å¿—**ï¼š
```
[OS] [SlaveEscape][Teleport] Position2D setter exists=True isPublic=False
[OS] [SlaveEscape][Teleport] ä½¿ç”¨ setMethod.Invoke è®¾ç½®ä½ç½®: success=True
[OS] [SlaveEscape][Teleport] after=(450.00,650.00) success=True
```

---

### 4. Settlement åæ ‡/ç±»å‹å¼ºåˆ¶æ ¡éªŒï¼ˆé˜²æ­¢ç±»å‹é”™è¯¯ï¼‰

**éªŒè¯ç‚¹**ï¼š`Settlement.Position` çš„ç±»å‹å’Œå±æ€§æ˜¯å¦æ­£ç¡®

**å¿…é¡»è¡¥å……çš„æ—¥å¿—**ï¼š
```csharp
// åœ¨æŸ¥æ‰¾ settlement æ—¶æ·»åŠ 
var settlementPos = targetSettlement.Position;
OriginLog.Info($"[SlaveEscape][Teleport] Settlement.Position type={settlementPos.GetType().FullName}");
OriginLog.Info($"[SlaveEscape][Teleport] Settlement.Culture={targetSettlement.Culture?.StringId ?? "null"}");
OriginLog.Info($"[SlaveEscape][Teleport] Settlement.Name={targetSettlement.Name.ToString()}");
```

**å¿…é¡»æä¾›çš„æ—¥å¿—**ï¼š
```
[OS] [SlaveEscape][Teleport] Settlement.Position type=TaleWorlds.CampaignSystem.CampaignVec2
[OS] [SlaveEscape][Teleport] Settlement.Culture=aserai
[OS] [SlaveEscape][Teleport] Settlement.Name=Quyaz
```

---

### 5. è¿ç»­ Tick éªŒè¯ï¼ˆé˜²æ­¢å¼•æ“è¦†ç›–ä½ç½®ï¼‰

**éªŒè¯ç‚¹**ï¼šä½ç½®è®¾ç½®åï¼Œæ˜¯å¦åœ¨æ¥ä¸‹æ¥çš„ N å¸§è¢«å¼•æ“è¦†ç›–å›é»˜è®¤å‡ºç”Ÿç‚¹

**å½“å‰ä»£ç é—®é¢˜**ï¼š
- åªéªŒè¯äº† `VerifyNextTick` ä¸€æ¬¡ï¼ˆä¸‹ä¸€å¸§ï¼‰
- Bannerlord å¯èƒ½åœ¨è§’è‰²åˆ›å»ºç»“æŸåçš„æŸä¸ªæµç¨‹å†æŠŠå‡ºç”Ÿç‚¹å†™å›å»

**å¿…é¡»è¡¥å……çš„éªŒè¯**ï¼š
```csharp
// åœ¨ OriginSystemCampaignBehavior.OnTick ä¸­æ·»åŠ è¿ç»­éªŒè¯
private int _verifyTickCount = 0;
private const int MAX_VERIFY_TICKS = 50; // éªŒè¯ 50 æ¬¡ tickï¼ˆçº¦ 2 ç§’ï¼‰

if (_verifyNextTick)
{
    _verifyTickCount++;
    Vec2 currentPos = Vec2.Invalid;
    var posProp = typeof(MobileParty).GetProperty("Position2D", BindingFlags.Public | BindingFlags.Instance);
    if (posProp != null)
    {
        currentPos = (Vec2)posProp.GetValue(MobileParty.MainParty);
    }
    
    OriginLog.Info($"[SlaveEscape][VerifyTick] tick={_verifyTickCount} pos=({currentPos.X:F2},{currentPos.Y:F2})");
    
    if (_verifyTickCount >= MAX_VERIFY_TICKS)
    {
        _verifyNextTick = false;
        _verifyTickCount = 0;
        OriginLog.Info("[SlaveEscape][VerifyTick] è¿ç»­éªŒè¯å®Œæˆï¼Œä½ç½®æœªå›è·³");
    }
}
```

**å¿…é¡»æä¾›çš„æ—¥å¿—**ï¼š
```
[OS] [SlaveEscape][Teleport] after=(450.00,650.00) success=True
[OS] [SlaveEscape][VerifyTick] tick=1 pos=(450.00,650.00)
[OS] [SlaveEscape][VerifyTick] tick=2 pos=(450.00,650.00)
...
[OS] [SlaveEscape][VerifyTick] tick=50 pos=(450.00,650.00)
[OS] [SlaveEscape][VerifyTick] è¿ç»­éªŒè¯å®Œæˆï¼Œä½ç½®æœªå›è·³
```

**å¦‚æœä½ç½®å›è·³**ï¼š
```
[OS] [SlaveEscape][VerifyTick] tick=1 pos=(450.00,650.00)
[OS] [SlaveEscape][VerifyTick] tick=2 pos=(100.00,200.00)  â† ä½ç½®è¢«è¦†ç›–ï¼
[OS] [SlaveEscape][VerifyTick] ä½ç½®è¢«å¼•æ“è¦†ç›–ï¼Œéœ€è¦è°ƒæ•´æ—¶æœº
```

---

### 6. Y è½´æ–¹å‘éªŒè¯ï¼ˆä¸è¦æå‰ä¸‹ç»“è®ºï¼‰

**éªŒè¯ç‚¹**ï¼šY è¶Šå¤§æ˜¯å¦çœŸçš„è¶Šé å—ï¼ˆéœ€è¦è¿è¡Œæ—¶ç¡®è®¤ï¼‰

**å½“å‰ä»£ç é—®é¢˜**ï¼š
- æŠ¥å‘Šé‡Œå†™æ­»äº†"Y æœ€å¤§ = æœ€å—"ï¼Œè¿™æ˜¯ç»“è®ºæå‰
- éœ€è¦è¿è¡Œæ—¶æŸ¥çœ‹åŸå¸‚åæ ‡åˆ—è¡¨ï¼Œå¯¹æ¯”å·²çŸ¥åŸå¸‚ä½ç½®

**å¿…é¡»æä¾›çš„æ—¥å¿—**ï¼š
```
[OS] [SlaveEscape][Teleport] é˜¿å¡è±åŸå¸‚åˆ—è¡¨ï¼ˆç”¨äºéªŒè¯ Y è½´æ–¹å‘ï¼‰:
  - Quyaz (town_AN1) Pos=(450.00,650.00)
  - Sanala (town_AN2) Pos=(420.00,620.00)
  - Husn Fulq (town_AN3) Pos=(400.00,600.00)
```

**éªŒè¯æ–¹æ³•**ï¼š
1. è¿è¡Œæ¸¸æˆï¼ŒæŸ¥çœ‹æ—¥å¿—ä¸­çš„åŸå¸‚åæ ‡åˆ—è¡¨
2. å¯¹æ¯”æ¸¸æˆåœ°å›¾ï¼Œç¡®è®¤å“ªä¸ªåŸå¸‚æœ€é å—
3. å¦‚æœæœ€å—çš„åŸå¸‚ Y å€¼æœ€å¤§ â†’ ä½¿ç”¨ `OrderByDescending(s => s.Position.Y)`
4. å¦‚æœæœ€å—çš„åŸå¸‚ Y å€¼æœ€å° â†’ ä½¿ç”¨ `OrderBy(s => s.Position.Y)`

**å»ºè®®**ï¼šç”¨å·²çŸ¥åŸå¸‚åšé”šç‚¹ï¼ˆå¦‚ Husn Fulq / Quyazï¼‰ï¼Œå¯¹æ¯”å®ƒä»¬çš„ Y æ¥ç¡®å®šå—åŒ—æ–¹å‘ã€‚

---

## ğŸ“‹ è¿è¡Œæ—¶éªŒè¯æ¸…å•ï¼ˆå¿…é¡»å…¨éƒ¨é€šè¿‡ï¼‰

- [ ] **Patch è¢«è°ƒç”¨**ï¼šæ—¥å¿—ä¸­å‡ºç° `[SlaveEscape][Finalize] OnCharacterCreationFinalized Postfix called`
- [ ] **Pending ä¿ç•™**ï¼šä» Node5 OnSelect åˆ° Finalize Postfixï¼Œ`PendingStartDirection` ä¸€ç›´å­˜åœ¨
- [ ] **Setter ç”Ÿæ•ˆ**ï¼šæ—¥å¿—æ˜¾ç¤º `Position2D setter exists=True` ä¸” `after` ä½ç½®æ­£ç¡®
- [ ] **Settlement ç±»å‹æ­£ç¡®**ï¼š`Settlement.Position type=TaleWorlds.CampaignSystem.CampaignVec2`
- [ ] **è¿ç»­éªŒè¯é€šè¿‡**ï¼šè¿ç»­ 50 æ¬¡ tickï¼ˆçº¦ 2 ç§’ï¼‰ä½ç½®æœªå›è·³
- [ ] **Y è½´æ–¹å‘ç¡®è®¤**ï¼šé€šè¿‡åŸå¸‚åæ ‡åˆ—è¡¨ç¡®è®¤ Y è½´æ–¹å‘ï¼Œè°ƒæ•´ä»£ç ä½¿ç”¨ `MaxY` æˆ– `MinY`

---

## âœ… æœ€ç»ˆç»“è®º

**é™æ€èµ°æŸ¥é€šè¿‡ï¼Œè¿è¡Œæ—¶å¾…è¯**ï¼š

1. âœ… **ä»£ç é€»è¾‘å®Œæ•´**ï¼šèœå•è·¯ç”±ã€Node5 é€‰æ‹©ã€å‡ºç”ŸèƒŒæ™¯ã€å‡ºç”Ÿä½ç½®çš„ä»£ç é€»è¾‘éƒ½å·²å®ç°
2. âš ï¸ **è¿è¡Œæ—¶éªŒè¯å¾…å®Œæˆ**ï¼šå¿…é¡»æä¾›ä¸Šè¿° 6 ä¸ªéªŒè¯ç‚¹çš„çœŸå®æ—¥å¿—ï¼Œæ‰èƒ½ç¡®è®¤å®ç°ç”Ÿæ•ˆ
3. âš ï¸ **æ½œåœ¨é—®é¢˜**ï¼š
   - Patch å¯èƒ½æœªæ³¨å†Œæˆ–ç­¾åä¸å¯¹
   - `PendingStartDirection` å¯èƒ½è¢« `ResetState()` æ¸…ç©º
   - `Position2D` setter å¯èƒ½é™é»˜å¤±è´¥
   - ä½ç½®å¯èƒ½è¢«å¼•æ“è¦†ç›–
   - Y è½´æ–¹å‘å¯èƒ½åäº†

**ä¸‹ä¸€æ­¥**ï¼šè¿è¡Œæ¸¸æˆï¼Œé€‰æ‹©é€ƒå¥´ â†’ é€‰æ‹©"æ²™æ¼ æ·±å¤„"ï¼Œæä¾›ä¸Šè¿° 6 ä¸ªéªŒè¯ç‚¹çš„çœŸå®æ—¥å¿—ã€‚

---

## ğŸ“‹ ä»£ç æ”¹è¿›ï¼ˆå·²å®ç°ï¼‰

### 1. Position2D Setter æ›´ä¸¥æ ¼æ£€æŸ¥

**æ”¹è¿›**ï¼šä½¿ç”¨ `GetSetMethod(true)` è·å– setterï¼ˆåŒ…æ‹¬ non-publicï¼‰ï¼Œå¹¶è®°å½•æ—¥å¿—

**ä»£ç ä½ç½®**ï¼š`SubModule/PresetOriginSystem.cs` ç¬¬1450-1480è¡Œ

**æ–°å¢æ—¥å¿—**ï¼š
- `Position2D setter exists={setMethod != null} isPublic={setMethod?.IsPublic ?? false}`
- `ä½¿ç”¨ setMethod.Invoke è®¾ç½®ä½ç½®: success=True`

### 2. Settlement ç±»å‹å¼ºåˆ¶æ ¡éªŒ

**æ”¹è¿›**ï¼šè®°å½• `Settlement.Position` çš„ç±»å‹ã€Cultureã€Name

**ä»£ç ä½ç½®**ï¼š`SubModule/PresetOriginSystem.cs` ç¬¬1441-1448è¡Œ

**æ–°å¢æ—¥å¿—**ï¼š
- `Settlement.Position type={settlementPos.GetType().FullName}`
- `Settlement.Culture={targetSettlement.Culture?.StringId}`
- `Settlement.Name={targetSettlement.Name.ToString()}`

### 3. è¿ç»­ Tick éªŒè¯

**æ”¹è¿›**ï¼šè¿ç»­éªŒè¯ 50 æ¬¡ tickï¼ˆçº¦ 2 ç§’ï¼‰ï¼Œè€Œä¸æ˜¯åªéªŒè¯ä¸€æ¬¡

**ä»£ç ä½ç½®**ï¼š`SubModule/OriginSystemCampaignBehavior.cs` ç¬¬60-72è¡Œ

**æ–°å¢æ—¥å¿—**ï¼š
- `[SlaveEscape][VerifyTick] tick={_verifyTickCount} pos=(...)`
- `[SlaveEscape][VerifyTick] è¿ç»­éªŒè¯å®Œæˆï¼Œä½ç½®æœªå›è·³`

### 4. ResetState æ—¥å¿—

**æ”¹è¿›**ï¼šè®°å½• `ResetState()` ä½•æ—¶è¢«è°ƒç”¨ï¼Œæ¸…ç©ºäº†å“ªäº› Pending å€¼

**ä»£ç ä½ç½®**ï¼š`SubModule/OriginSystemHelper.cs` ç¬¬42-53è¡Œ

**æ–°å¢æ—¥å¿—**ï¼š
- `[ResetState] æ¸…ç©ºäº† PendingStartDirection={oldPendingDirection} PendingStartSettlementId={oldPendingSettlementId}`

---

## ç¼–è¯‘çŠ¶æ€

```
ç¼–è¯‘å‘½ä»¤: msbuild OriginSystemMod.csproj /p:Configuration=Release /p:Platform=x64 /nologo /v:minimal
ç¼–è¯‘ç»“æœ: âœ… 0 errors, 0 warnings
```

---

## ğŸ“‹ è‡ªæŸ¥æ¸…å•ï¼ˆå¿…é¡»å…¨éƒ¨é€šè¿‡ï¼‰

- [ ] **ç¼–è¯‘é€šè¿‡**ï¼š`msbuild OriginSystemMod.csproj /p:Configuration=Release /p:Platform=x64` â†’ 0 errors, 0 warnings
- [ ] **Patch æ—¥å¿—å‡ºç°**ï¼šè¿è¡Œæ¸¸æˆï¼Œé€‰æ‹©é€ƒå¥´ â†’ é€‰æ‹©"æ²™æ¼ æ·±å¤„"ï¼Œæ—¥å¿—ä¸­å‡ºç° `[SlaveEscape][Finalize] OnCharacterCreationFinalized Postfix called`
- [ ] **Pending å€¼ä¿ç•™**ï¼šä» Node5 OnSelect åˆ° Finalize Postfixï¼Œ`PendingStartDirection` ä¸€ç›´å­˜åœ¨ï¼ˆæ—¥å¿—ä¸­èƒ½çœ‹åˆ° `[SlaveEscape][Node5] å·²ä¿å­˜æœŸæœ›å‡ºç”Ÿä½ç½®: direction=desert` å’Œ `[SlaveEscape][Finalize] å¼€å§‹è®¾ç½®å‡ºç”Ÿä½ç½®: direction=desert`ï¼‰
- [ ] **Setter ç”Ÿæ•ˆ**ï¼šæ—¥å¿—æ˜¾ç¤º `Position2D setter exists=True` ä¸” `after` ä½ç½®æ­£ç¡®
- [ ] **Settlement ç±»å‹æ­£ç¡®**ï¼šæ—¥å¿—æ˜¾ç¤º `Settlement.Position type=TaleWorlds.CampaignSystem.CampaignVec2`
- [ ] **è¿ç»­éªŒè¯é€šè¿‡**ï¼šè¿ç»­ 50 æ¬¡ tickï¼ˆçº¦ 2 ç§’ï¼‰ä½ç½®æœªå›è·³ï¼ˆæ—¥å¿—ä¸­èƒ½çœ‹åˆ° `[SlaveEscape][VerifyTick] tick=1` åˆ° `tick=50`ï¼Œä½ç½®ä¿æŒä¸€è‡´ï¼‰
- [ ] **Y è½´æ–¹å‘ç¡®è®¤**ï¼šé€šè¿‡åŸå¸‚åæ ‡åˆ—è¡¨ç¡®è®¤ Y è½´æ–¹å‘ï¼Œå¦‚æœæœ€å—çš„åŸå¸‚ Y å€¼æœ€å°ï¼Œéœ€è¦ä¿®æ”¹ä»£ç ä½¿ç”¨ `OrderBy` è€Œä¸æ˜¯ `OrderByDescending`
- [ ] **æœªå¼•å…¥æ–° warning**ï¼šç¼–è¯‘æ—¶æ²¡æœ‰æ–°çš„ warning
- [ ] **æœªæ”¹åŠ¨æ— å…³èœå•ä¸è·¯ç”±**ï¼šåªä¿®æ”¹äº†é€ƒå¥´ç›¸å…³çš„ä»£ç ï¼Œæ²¡æœ‰æ”¹åŠ¨å…¶ä»–å‡ºèº«çš„èœå•å’Œè·¯ç”±

