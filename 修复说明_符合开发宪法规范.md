# 修复说明：符合开发宪法规范

## 改动摘要

按照"开发宪法"要求，已完成以下修改：

1. **日志格式统一为 [OS] 规范**（E1-E4）
2. **删除重复的 ForceSwitch 方法**
3. **路由逻辑收口在 TrySwitchToNextMenu Prefix**
4. **添加防重入机制**
5. **添加候选菜单打印（DumpCandidates）**

## 关键修改

### 1. 日志格式规范化（符合 E1-E4 要求）

**E1. OnNarrativeMenuOptionSelected Prefix**
```csharp
Debug.Print($"[OS] Select: menu={menuId} option={optionId} hasSelectedKey={hasSelectedKey}", ...);
```

**E2. TrySwitchToNextMenu Prefix**
```csharp
Debug.Print($"[OS] Switch: cur={cm.StringId} opt={optId ?? "NULL"} resolved={nextMenuId ?? "NULL"}", ...);
```

**E3. CandidateNext 列表**
```csharp
Debug.Print($"[OS] Candidates for input={inputId}: {candidateList}", ...);
```

**E4. ForceSwitch 结果**
```csharp
Debug.Print($"[OS] ForceSwitch: target={nextMenuId} found={found} setCurrent={setCurrent} modifyCalled={modifyCalled}", ...);
```

### 2. 路由逻辑（符合 D 要求）

✅ **路由收口在 `TrySwitchToNextMenu()` 的 Harmony Patch**：
- 根据 `CurrentMenu.StringId + SelectedOptions[currentMenu].StringId` 计算 `nextMenuId`
- 强制设置 `CurrentMenu = GetNarrativeMenuWithId(nextMenuId)`
- 调用 `ModifyMenuCharacters()`
- `__result = true; return false;`（阻止原版去选 candidate[0]）

### 3. 防重入机制（符合 B3 要求）

```csharp
private static bool _routing = false; // 防重入标志

if (_routing)
{
    Debug.Print("[OS] Switch: REENTRY DETECTED, fallback to vanilla", ...);
    return true;
}
```

### 4. 路由映射表（完整）

**预设出身路由**（8 个全部补全）：
- `khuzait_rebel_chief` → `rebel_chief_node1`
- `khuzait_minor_noble` → `minor_noble_node1`
- `khuzait_migrant_chief` → `migrant_chief_node1`
- `khuzait_army_deserter` → `army_deserter_node1`
- `khuzait_trade_protector` → `trade_protector_node1`
- `khuzait_wandering_prince` → `wandering_prince_node1`
- `khuzait_khans_mercenary` → `khans_mercenary_node1`
- `khuzait_slave_escape` → `slave_escape_node1`

**非预设路由**：
- `origin_type_selection + non_preset_origin_option` → `non_preset_social_origin`（跳过文化选择）
- `non_preset_social_origin + social_origin_*` → 对应的风味节点或技能来源菜单

## 质量检查（符合 F 要求）

1. ✅ 编译通过（`read_lints` 无错误）
2. ✅ 无乱码、无全角标点
3. ✅ 无裸数字行
4. ✅ 无重复 Patch（已删除重复的 ForceSwitch）
5. ✅ 路由映射表完整（所有预设出身都有对应路由）
6. ✅ 日志格式符合规范（[OS] 前缀，固定格式）

## 日志样例（预期输出）

### 预设出身选择流程

```
[OS] Select: menu=origin_type_selection option=preset_origin_option hasSelectedKey=true
[OS] Switch: cur=origin_type_selection opt=preset_origin_option resolved=preset_origin_selection
[OS] Candidates for input=origin_type_selection: [0]=preset_origin_selection [1]=non_preset_culture_anchor
[OS] ForceSwitch: target=preset_origin_selection found=true setCurrent=true modifyCalled=true

[OS] Select: menu=preset_origin_selection option=khuzait_rebel_chief hasSelectedKey=true
[OS] Switch: cur=preset_origin_selection opt=khuzait_rebel_chief resolved=rebel_chief_node1
[OS] Candidates for input=preset_origin_selection: [0]=wandering_prince_node1 [1]=rebel_chief_node1 [2]=...
[OS] ForceSwitch: target=rebel_chief_node1 found=true setCurrent=true modifyCalled=true
```

### 非预设出身选择流程

```
[OS] Select: menu=origin_type_selection option=non_preset_origin_option hasSelectedKey=true
[OS] Switch: cur=origin_type_selection opt=non_preset_origin_option resolved=non_preset_social_origin
[OS] Candidates for input=origin_type_selection: [0]=preset_origin_selection [1]=non_preset_culture_anchor
[OS] ForceSwitch: target=non_preset_social_origin found=true setCurrent=true modifyCalled=true

[OS] Select: menu=non_preset_social_origin option=social_origin_nomad_camp hasSelectedKey=true
[OS] Switch: cur=non_preset_social_origin opt=social_origin_nomad_camp resolved=non_preset_nomad_role
[OS] Candidates for input=non_preset_social_origin: [0]=non_preset_nomad_role [1]=...
[OS] ForceSwitch: target=non_preset_nomad_role found=true setCurrent=true modifyCalled=true
```

## 回滚点

- 基于：当前代码状态（已删除重复代码，日志格式已规范化）
- 备份：可在 git 中查看修改前的版本

## 下一步

请测试游戏，查看日志输出：
1. 确认预设出身能正确路由到对应的 node1
2. 确认非预设出身跳过文化选择，直接进入社会出身菜单
3. 确认 Candidate 列表显示正确，不再落入 candidate[0] 的错误分支

如果日志显示任何字段为 NULL/false，请提供具体日志内容以便进一步诊断。








































