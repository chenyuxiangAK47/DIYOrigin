# 预设出身效果应用说明

## 概述

本文档说明预设出身系统如何应用开局状态，包括家族等级、关系、雇佣状态等。

## 实现位置

- **PresetOriginSystem.cs** - 预设出身应用逻辑
- **OriginSystemCampaignBehavior.cs** - 在战役开始时调用应用逻辑

## 应用时机

预设出身效果在 `OnSessionLaunched` 事件中应用，即战役完全启动后。

## 各预设出身效果

### 1. 草原叛酋 (rebel_chief)
- **家族等级**：1级
- **关系**：与库塞特关系-50（敌对）
- **初始金币**：5000
- **说明**：被汗廷定性的叛酋，与库塞特关系敌对

### 2. 汗廷旁支贵族 (minor_noble)
- **家族等级**：3级
- **贵族状态**：是（is_noble = true）
- **关系**：与库塞特关系+20，与精英氏族关系+10
- **初始金币**：15000
- **说明**：开局就是没封地的3级库塞特贵族家族

### 3. 西迁部族首领 (migrant_chief)
- **家族等级**：2级
- **关系**：与库塞特关系-10
- **初始金币**：8000
- **说明**：被迫迁徙的部族，与库塞特关系略差

### 4. 汗廷军叛逃者 (army_deserter)
- **家族等级**：1级
- **关系**：与库塞特关系-40（敌对）
- **初始金币**：6000
- **说明**：背叛军团的军官，与库塞特关系敌对

### 5. 草原商路守护者 (trade_protector)
- **家族等级**：2级
- **关系**：中立（与商人关系良好，通过金币体现）
- **初始金币**：12000
- **说明**：守护商路的商人，资源较多

### 6. 迁徙王族 (wandering_prince)
- **家族等级**：3级
- **贵族状态**：是（is_noble = true）
- **声望**：+200
- **关系**：与库塞特关系-20（王族威胁）
- **初始金币**：20000
- **说明**：流亡的王族，声望高但关系复杂

### 7. 可汗的雇佣战帮 (khans_mercenary)
- **家族等级**：1级
- **雇佣状态**：是（is_mercenary = true, is_minor_faction = true）
- **关系**：与库塞特关系+30（雇佣关系）
- **初始金币**：10000
- **说明**：开局就是一级家族且是雇佣关系

### 8. 逃出沙漠的战奴 (slave_escape)
- **家族等级**：0级
- **关系**：与阿塞莱关系-60（极差）
- **初始金币**：3000
- **说明**：如果选择阿塞莱相关选项，与阿塞莱关系很差

### 9. 草原自由民 (free_cossack)
- **家族等级**：1级
- **关系**：与库塞特关系0（中立）
- **初始金币**：7000
- **说明**：独立的自由民，关系中立

### 10. 东方旧部复仇者 (old_guard_avenger)
- **家族等级**：2级
- **关系**：与库塞特关系-30（敌对）
- **初始金币**：9000
- **说明**：带着旧部复仇，与库塞特关系敌对

## 技术实现

### 设置家族等级

使用反射设置 `Clan.Tier` 属性，如果失败则尝试使用 `ChangeClanTierAction`（如果存在）。

```csharp
private static void SetClanTier(Clan clan, int tier)
{
    var tierProperty = typeof(Clan).GetProperty("Tier", ...);
    if (tierProperty != null && tierProperty.CanWrite)
    {
        tierProperty.SetValue(clan, tier);
    }
}
```

### 设置贵族状态

使用反射设置 `Clan.IsNoble` 属性。

```csharp
private static void SetClanNoble(Clan clan, bool isNoble)
{
    var isNobleProperty = typeof(Clan).GetProperty("IsNoble", ...);
    if (isNobleProperty != null && isNobleProperty.CanWrite)
    {
        isNobleProperty.SetValue(clan, isNoble);
    }
}
```

### 设置雇佣兵状态

使用反射设置 `Clan.IsMinorFaction` 和 `Clan.IsMercenary` 属性。

```csharp
private static void SetClanMercenary(Clan clan, bool isMercenary)
{
    // 设置 IsMinorFaction 和 IsMercenary
}
```

### 设置关系

使用 `ChangeRelationAction.ApplyPlayerRelation()` 设置与各派系的关系。

```csharp
ChangeRelationAction.ApplyPlayerRelation(kingdom.Leader, relationValue);
```

### 设置金币

使用 `GiveGoldAction.ApplyBetweenCharacters()` 设置初始金币。

```csharp
GiveGoldAction.ApplyBetweenCharacters(null, hero, goldAmount, false);
```

## 注意事项

1. **反射使用**：由于某些属性可能是私有的，使用反射来设置。如果反射失败，会记录警告日志。

2. **API可用性**：某些API（如 `ChangeClanTierAction`、`GainRenownAction`）可能在不同版本中有所不同，代码中已做兼容处理。

3. **关系设置**：关系值范围通常是 -100 到 +100，-50以下为敌对，+20以上为友好。

4. **家族等级**：家族等级范围通常是 0-6，0级为最低，6级为最高。

5. **雇佣关系**：设置雇佣关系可能需要额外的API调用，当前实现尝试设置相关属性。

## 后续扩展

1. **初始兵力**：根据节点选择添加初始兵力（需要解析 `SelectedPresetOriginNodes`）

2. **初始装备**：根据节点选择添加初始装备

3. **初始位置**：根据出身设置初始位置

4. **特殊标记**：设置特殊标记（如 `flag_is_suspected`、`flag_has_grudge` 等）

5. **雇佣关系**：完善雇佣关系的设置（可能需要加入雇佣合同）

## 测试建议

1. 测试每个预设出身的家族等级是否正确设置
2. 测试关系值是否正确应用
3. 测试金币是否正确给予
4. 测试贵族状态和雇佣状态是否正确设置
5. 测试与不同版本Bannerlord的兼容性























































