# é—®é¢˜åˆ†æï¼šæˆ˜å¥´é€ƒäº¡è·¯ç”±å¤±è´¥

**æ—¥æœŸï¼š** 2024-12-19  
**é—®é¢˜ï¼š** é€‰æ‹©"æˆ˜å¥´é€ƒäº¡"åï¼Œæ— æ³•è·³è½¬åˆ°èŠ‚ç‚¹èœå•ï¼ŒæŠ¥é”™"æ‰¾ä¸åˆ°ç›®æ ‡èœå• preset_slave_escape"

---

## ğŸ” æ—¥å¿—åˆ†æ

### å…³é”®é”™è¯¯æ—¥å¿—
```
[12:59:39.300] [OS] ç”¨æˆ·é€‰æ‹©äº†æˆ˜å¥´é€ƒäº¡
[12:59:39.300] [OS] Postfix: PendingMenuSwitch=preset_slave_escape (ä¿ç•™ç»™TrySwitchToNextMenu ä½¿ç”¨)
[12:59:39.300] [OS] [Route] ä½¿ç”¨ PendingMenuSwitch: preset_slave_escape (cur=preset_origin_selection opt=khuzait_slave_escape)
[12:59:39.300] [OS] Switch: cur=preset_origin_selection opt=khuzait_slave_escape resolved=preset_slave_escape
[12:59:39.300] [OS][ERR] [Route] é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç›®æ ‡èœå• preset_slave_escape
```

### é—®é¢˜æµç¨‹
1. âœ… ç”¨æˆ·é€‰æ‹© `khuzait_slave_escape`ï¼ˆæˆ˜å¥´é€ƒäº¡ï¼‰
2. âœ… `SlaveEscapeOnSelect` è®¾ç½®äº† `PendingMenuSwitch = "preset_slave_escape"`
3. âœ… è·¯ç”±ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨äº† `PendingMenuSwitch`
4. âŒ **è·¯ç”±ç³»ç»Ÿå°è¯•æŸ¥æ‰¾èœå• `preset_slave_escape`ï¼Œä½†æ‰¾ä¸åˆ°**
5. âŒ è·¯ç”±å¤±è´¥ï¼Œæ¸¸æˆè·³è½¬åˆ° banner_editor_sceneï¼ˆæ——å¸œç¼–è¾‘å™¨ï¼‰

---

## ğŸ› æ ¹æœ¬åŸå› 

### é—®é¢˜ä»£ç ä½ç½®
**æ–‡ä»¶ï¼š** `SubModule/Menus/Preset/PresetOriginSelectionMenu.cs`  
**è¡Œå·ï¼š** 209  
**ä»£ç ï¼š**
```csharp
OriginSystemHelper.PendingMenuSwitch = "preset_slave_escape";
```

### é—®é¢˜åˆ†æ

1. **é”™è¯¯çš„èœå•ID**
   - ä»£ç è®¾ç½®äº† `PendingMenuSwitch = "preset_slave_escape"`
   - ä½†å®é™…çš„èœå•IDæ˜¯ `slave_escape_node1`ï¼ˆå®šä¹‰åœ¨ `SlaveEscapeNodes.cs` ç¬¬18è¡Œï¼‰

2. **è·¯ç”±ç³»ç»Ÿçš„å·¥ä½œæ–¹å¼**
   - `OriginMenuRouter.cs` ç¬¬22-28è¡Œï¼šä¼˜å…ˆä½¿ç”¨ `PendingMenuSwitch`
   - å¦‚æœ `PendingMenuSwitch` å­˜åœ¨ï¼Œç›´æ¥è¿”å›è¿™ä¸ªå€¼ï¼Œ**ä¸ä¼šèµ°æ­£å¸¸çš„è·¯ç”±é€»è¾‘**
   - æ­£å¸¸è·¯ç”±é€»è¾‘ï¼ˆç¬¬42-45è¡Œï¼‰ä¼šæ ¹æ®é€‰é¡¹IDä»è·¯ç”±è¡¨æŸ¥æ‰¾ï¼š
     ```csharp
     if (curMenuId == "preset_origin_selection")
     {
         return KhuzaitRoutes.GetPresetOriginNode1(optId);
     }
     ```
   - è·¯ç”±è¡¨ `OriginRoutes.Khuzait.cs` ç¬¬23è¡Œæœ‰æ­£ç¡®çš„æ˜ å°„ï¼š
     ```csharp
     { "khuzait_slave_escape", "slave_escape_node1" }
     ```

3. **å†²çª**
   - å› ä¸ºè®¾ç½®äº† `PendingMenuSwitch`ï¼Œè·¯ç”±ç³»ç»Ÿè·³è¿‡äº†æ­£å¸¸çš„è·¯ç”±é€»è¾‘
   - ç›´æ¥ä½¿ç”¨ `preset_slave_escape` å»æŸ¥æ‰¾èœå•ï¼Œä½†è¿™ä¸ªèœå•ä¸å­˜åœ¨
   - åº”è¯¥ä½¿ç”¨ `slave_escape_node1`

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®æ”¹ PendingMenuSwitch çš„å€¼ï¼ˆæ¨èï¼‰

**æ–‡ä»¶ï¼š** `SubModule/Menus/Preset/PresetOriginSelectionMenu.cs`  
**ä¿®æ”¹ï¼š** ç¬¬209è¡Œ

**ä¿®æ”¹å‰ï¼š**
```csharp
OriginSystemHelper.PendingMenuSwitch = "preset_slave_escape";
```

**ä¿®æ”¹åï¼š**
```csharp
OriginSystemHelper.PendingMenuSwitch = "slave_escape_node1";
```

**ä¼˜ç‚¹ï¼š**
- æœ€å°åŒ–ä¿®æ”¹ï¼ˆåªæ”¹1è¡Œï¼‰
- ç›´æ¥ä½¿ç”¨æ­£ç¡®çš„èœå•ID
- ç¬¦åˆç°æœ‰è·¯ç”±æœºåˆ¶

### æ–¹æ¡ˆ2ï¼šç§»é™¤ PendingMenuSwitchï¼Œè®©è·¯ç”±ç³»ç»Ÿè‡ªåŠ¨å¤„ç†

**æ–‡ä»¶ï¼š** `SubModule/Menus/Preset/PresetOriginSelectionMenu.cs`  
**ä¿®æ”¹ï¼š** åˆ é™¤ç¬¬209è¡Œ

**ä¿®æ”¹åï¼š**
```csharp
private static void SlaveEscapeOnSelect(CharacterCreationManager characterCreationManager)
{
    try
    {
        OriginLog.Info("ç”¨æˆ·é€‰æ‹©äº†æˆ˜å¥´é€ƒäº¡");
        OriginSystemHelper.SelectedPresetOriginId = "khuzait_slave_escape";
        OriginSystemHelper.IsPresetOrigin = true;
        // åˆ é™¤è¿™è¡Œï¼šOriginSystemHelper.PendingMenuSwitch = "preset_slave_escape";
    }
    catch (Exception ex)
    {
        OriginLog.Error($"SlaveEscapeOnSelect å¤±è´¥: {ex.Message}");
    }
}
```

**ä¼˜ç‚¹ï¼š**
- è®©è·¯ç”±ç³»ç»Ÿè‡ªåŠ¨æ ¹æ®é€‰é¡¹IDæŸ¥æ‰¾èœå•
- ä½¿ç”¨è·¯ç”±è¡¨ `OriginRoutes.Khuzait.cs` ä¸­çš„æ˜ å°„
- æ›´ç¬¦åˆè·¯ç”±ç³»ç»Ÿçš„è®¾è®¡

**ç¼ºç‚¹ï¼š**
- éœ€è¦ç¡®è®¤å…¶ä»–é¢„è®¾å‡ºèº«æ˜¯å¦ä¹Ÿä¾èµ– `PendingMenuSwitch`

---

## âš ï¸ ç³»ç»Ÿæ€§é—®é¢˜

**é‡è¦å‘ç°ï¼š** æ‰€æœ‰é¢„è®¾å‡ºèº«éƒ½ä½¿ç”¨äº†é”™è¯¯çš„ `PendingMenuSwitch` å€¼ï¼

### æ‰€æœ‰é¢„è®¾å‡ºèº«çš„ PendingMenuSwitch è®¾ç½®
```
preset_rebel_chief          â†’ åº”è¯¥æ˜¯ rebel_chief_node1
preset_wandering_prince    â†’ åº”è¯¥æ˜¯ wandering_prince_node1
preset_slave_escape        â†’ åº”è¯¥æ˜¯ slave_escape_node1 âŒï¼ˆå½“å‰é—®é¢˜ï¼‰
preset_minor_noble         â†’ åº”è¯¥æ˜¯ minor_noble_node1
preset_migrant_chief       â†’ åº”è¯¥æ˜¯ migrant_chief_node1
preset_army_deserter       â†’ åº”è¯¥æ˜¯ army_deserter_node1
preset_trade_protector     â†’ åº”è¯¥æ˜¯ trade_protector_node1
preset_khans_mercenary     â†’ åº”è¯¥æ˜¯ khans_mercenary_node1
preset_free_cossack        â†’ åº”è¯¥æ˜¯ free_cossack_node1
preset_old_guard_avenger   â†’ åº”è¯¥æ˜¯ old_guard_avenger_node1
```

**ç»“è®ºï¼š** è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§é—®é¢˜ï¼Œæ‰€æœ‰é¢„è®¾å‡ºèº«éƒ½å¯èƒ½å—åˆ°å½±å“ã€‚ä½†å¯èƒ½åªæœ‰"æˆ˜å¥´é€ƒäº¡"è¢«æµ‹è¯•äº†ï¼Œæ‰€ä»¥åªå‘ç°äº†è¿™ä¸€ä¸ªé—®é¢˜ã€‚

### ä¸ºä»€ä¹ˆå…¶ä»–é¢„è®¾å‡ºèº«å¯èƒ½"çœ‹èµ·æ¥æ­£å¸¸"ï¼Ÿ
1. å¯èƒ½è¿˜æ²¡æœ‰æµ‹è¯•å…¶ä»–é¢„è®¾å‡ºèº«
2. å¯èƒ½å…¶ä»–é¢„è®¾å‡ºèº«æœ‰å…¶ä»–çš„è·¯ç”±æœºåˆ¶ï¼ˆéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ï¼‰
3. å¯èƒ½æ¸¸æˆæœ‰é™çº§å¤„ç†ï¼Œè·³è½¬åˆ°äº†é»˜è®¤èœå•

## ğŸ” éªŒè¯å…¶ä»–é¢„è®¾å‡ºèº«

éœ€è¦æ£€æŸ¥å…¶ä»–é¢„è®¾å‡ºèº«çš„ `OnSelect` æ–¹æ³•æ˜¯å¦ä¹Ÿæœ‰ç±»ä¼¼é—®é¢˜ï¼š

1. **æ£€æŸ¥æ–‡ä»¶ï¼š** `SubModule/Menus/Preset/PresetOriginSelectionMenu.cs`
2. **æŸ¥æ‰¾æ‰€æœ‰ `PendingMenuSwitch` çš„è®¾ç½®**
3. **ç¡®è®¤æ¯ä¸ªå€¼æ˜¯å¦å¯¹åº”æ­£ç¡®çš„èœå•ID**

### å…¶ä»–é¢„è®¾å‡ºèº«çš„èœå•IDï¼ˆå‚è€ƒï¼‰
- `rebel_chief_node1` - è‰åŸå›é…‹
- `minor_noble_node1` - æ±—å»·æ—æ”¯è´µæ—
- `migrant_chief_node1` - è¿å¾™éƒ¨æ—é¦–é¢†
- `army_deserter_node1` - é€ƒå…µ
- `trade_protector_node1` - å•†é˜ŸæŠ¤å«
- `wandering_prince_node1` - æµäº¡ç‹å­
- `khans_mercenary_node1` - å¯æ±—ä½£å…µ
- `slave_escape_node1` - **æˆ˜å¥´é€ƒäº¡**ï¼ˆå½“å‰é—®é¢˜ï¼‰
- `free_cossack_node1` - è‡ªç”±å“¥è¨å…‹
- `old_guard_avenger_node1` - è€è¿‘å«å¤ä»‡è€…

---

## ğŸ“‹ ä¿®å¤æ­¥éª¤

### æ–¹æ¡ˆAï¼šä¿®å¤æ‰€æœ‰é¢„è®¾å‡ºèº«çš„ PendingMenuSwitchï¼ˆæ¨èï¼‰

1. **æ‰¹é‡ä¿®å¤æ‰€æœ‰é¢„è®¾å‡ºèº«**
   - æ–‡ä»¶ï¼š`SubModule/Menus/Preset/PresetOriginSelectionMenu.cs`
   - å°†æ‰€æœ‰ `"preset_xxx"` æ”¹ä¸ºå¯¹åº”çš„ `"xxx_node1"`

2. **ä¿®å¤æ˜ å°„è¡¨**
   ```
   preset_rebel_chief          â†’ rebel_chief_node1
   preset_wandering_prince    â†’ wandering_prince_node1
   preset_slave_escape        â†’ slave_escape_node1
   preset_minor_noble         â†’ minor_noble_node1
   preset_migrant_chief       â†’ migrant_chief_node1
   preset_army_deserter       â†’ army_deserter_node1
   preset_trade_protector     â†’ trade_protector_node1
   preset_khans_mercenary     â†’ khans_mercenary_node1
   preset_free_cossack        â†’ free_cossack_node1
   preset_old_guard_avenger   â†’ old_guard_avenger_node1
   ```

### æ–¹æ¡ˆBï¼šç§»é™¤æ‰€æœ‰ PendingMenuSwitchï¼Œè®©è·¯ç”±ç³»ç»Ÿè‡ªåŠ¨å¤„ç†

1. **åˆ é™¤æ‰€æœ‰ `PendingMenuSwitch` è®¾ç½®**
   - è®©è·¯ç”±ç³»ç»Ÿæ ¹æ®é€‰é¡¹IDè‡ªåŠ¨ä»è·¯ç”±è¡¨æŸ¥æ‰¾
   - è·¯ç”±è¡¨ `OriginRoutes.Khuzait.cs` å·²ç»æœ‰æ­£ç¡®çš„æ˜ å°„

2. **ä¼˜ç‚¹**
   - æ›´ç¬¦åˆè·¯ç”±ç³»ç»Ÿçš„è®¾è®¡
   - å‡å°‘ä»£ç é‡å¤
   - ç»Ÿä¸€ç®¡ç†è·¯ç”±é€»è¾‘

### æ–¹æ¡ˆCï¼šåªä¿®å¤æˆ˜å¥´é€ƒäº¡ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

1. **åªä¿®å¤æˆ˜å¥´é€ƒäº¡çš„ `PendingMenuSwitch`**
   - å°† `"preset_slave_escape"` æ”¹ä¸º `"slave_escape_node1"`
   - å…¶ä»–é¢„è®¾å‡ºèº«æš‚æ—¶ä¸åŠ¨ï¼ˆå¦‚æœå®ƒä»¬"çœ‹èµ·æ¥æ­£å¸¸"ï¼‰

4. **ç¼–è¯‘æµ‹è¯•**
   ```powershell
   cd "D:\SteamLibrary\steamapps\common\Mount & Blade II Bannerlord\Modules\OriginSystemMod"
   & "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe" "OriginSystemMod.csproj" /p:Configuration=Release /p:Platform=x64 /nologo /v:minimal
   ```

5. **æµ‹è¯•éªŒè¯**
   - é€‰æ‹©"é¢„è®¾å‡ºèº«" â†’ "æˆ˜å¥´é€ƒäº¡"
   - æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤è·¯ç”±æˆåŠŸï¼š
     ```
     [Route] ä½¿ç”¨ PendingMenuSwitch: slave_escape_node1
     Switch: cur=preset_origin_selection opt=khuzait_slave_escape resolved=slave_escape_node1
     ForceSwitch: target=slave_escape_node1 found=True setCurrent=True modifyCalled=True
     ```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `SubModule/Menus/Preset/PresetOriginSelectionMenu.cs` - é—®é¢˜ä»£ç ä½ç½®
- `SubModule/Routing/OriginMenuRouter.cs` - è·¯ç”±ç³»ç»Ÿé€»è¾‘
- `SubModule/Routing/OriginRoutes.Khuzait.cs` - è·¯ç”±æ˜ å°„è¡¨
- `SubModule/Menus/Preset/Nodes/SlaveEscapeNodes.cs` - æˆ˜å¥´é€ƒäº¡èŠ‚ç‚¹èœå•å®šä¹‰
- `SubModule/Patches/TrySwitchToNextMenuPatch.cs` - è·¯ç”±è¡¥ä¸

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æœ€å°åŒ–ä¿®æ”¹åŸåˆ™**
   - åªä¿®æ”¹å¿…è¦çš„ä»£ç 
   - ä¸è¦é‡æ„æ•´ä¸ªè·¯ç”±ç³»ç»Ÿ

2. **éªŒè¯è¦æ±‚**
   - å¿…é¡»æœ‰æ—¥å¿—è¯æ˜åŠŸèƒ½ç”Ÿæ•ˆ
   - ä¸èƒ½åªç»™ç†è®ºåˆ†æ

3. **ç¼–è¯‘è¦æ±‚**
   - 0 errors
   - 0 warnings

---

---

## ğŸ’¡ æ¨èæ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ¡ˆBï¼šç§»é™¤æ‰€æœ‰ `PendingMenuSwitch` è®¾ç½®**

**ç†ç”±ï¼š**
1. è·¯ç”±ç³»ç»Ÿ `OriginMenuRouter.cs` ç¬¬42-45è¡Œå·²ç»æœ‰æ­£ç¡®çš„é€»è¾‘ï¼š
   ```csharp
   if (curMenuId == "preset_origin_selection")
   {
       return KhuzaitRoutes.GetPresetOriginNode1(optId);
   }
   ```
2. è·¯ç”±è¡¨ `OriginRoutes.Khuzait.cs` å·²ç»æœ‰å®Œæ•´çš„æ˜ å°„
3. å‡å°‘ä»£ç é‡å¤ï¼Œç»Ÿä¸€ç®¡ç†è·¯ç”±é€»è¾‘
4. æ›´ç¬¦åˆ"æ•°æ®é©±åŠ¨"çš„è®¾è®¡ç†å¿µ

**å¦‚æœå¿…é¡»ä¿ç•™ `PendingMenuSwitch`ï¼š**
- ä½¿ç”¨æ–¹æ¡ˆAï¼Œå°†æ‰€æœ‰ `"preset_xxx"` æ”¹ä¸º `"xxx_node1"`

**å¦‚æœåªæƒ³å¿«é€Ÿä¿®å¤å½“å‰é—®é¢˜ï¼š**
- ä½¿ç”¨æ–¹æ¡ˆCï¼Œåªä¿®å¤æˆ˜å¥´é€ƒäº¡

---

**ä¸‹ä¸€æ­¥ï¼š** 
1. å†³å®šä½¿ç”¨å“ªä¸ªæ–¹æ¡ˆï¼ˆæ¨èæ–¹æ¡ˆBï¼‰
2. ä¿®å¤ `PresetOriginSelectionMenu.cs`
3. ç¼–è¯‘æµ‹è¯•
4. éªŒè¯æ‰€æœ‰é¢„è®¾å‡ºèº«æ˜¯å¦æ­£å¸¸å·¥ä½œ

