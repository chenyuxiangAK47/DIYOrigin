# 问题分析：预设走流亡节点和非预设流程错误

## 问题描述

### 问题 1：预设出身都走流亡的节点

**现象**：选择任何预设出身（草原叛酋、汗廷旁支贵族、西迁部族首领等），都进入了"迁徙王族"（流亡）的节点菜单。

**预期**：每个预设出身应该进入自己对应的节点菜单。

### 问题 2：非预设出身流程错误

**现象**：
1. 非预设出身需要选择文化（但开局会让你选文化，这里不需要）
2. 选出身和经历时显示的是"游牧营地"的节点（应该是非预设的节点）

**预期**：
1. 非预设出身应该跳过文化选择，直接进入社会出身菜单
2. 社会出身菜单应该显示非预设的选项（如工匠、商队、农民、城市贫民等）

## 代码分析

### 问题 1：预设出身路由不完整

**当前代码**（`OriginSystemPatches.cs` 第 5614-5635 行）：

```csharp
if (cm.StringId == "preset_origin_selection")
{
    // ...
    string nextId = null;
    switch (opt.StringId)
    {
        case "khuzait_wandering_prince":
            nextId = "wandering_prince_node1";
            break;
        case "khuzait_slave_escape":
            nextId = "slave_escape_node1";
            break;
        // 可以在这里添加其他预设出身的路由
    }
}
```

**问题**：只处理了 `khuzait_wandering_prince` 和 `khuzait_slave_escape`，其他预设出身（如 `khuzait_rebel_chief`、`khuzait_minor_noble` 等）没有路由，导致走原版逻辑，可能默认进入第一个匹配的菜单。

**需要的路由映射**：
- `khuzait_rebel_chief` → `rebel_chief_node1`
- `khuzait_minor_noble` → `minor_noble_node1`
- `khuzait_migrant_chief` → `migrant_chief_node1`
- `khuzait_army_deserter` → `army_deserter_node1`
- `khuzait_trade_protector` → `trade_protector_node1`
- `khuzait_wandering_prince` → `wandering_prince_node1`
- `khuzait_khans_mercenary` → `khans_mercenary_node1`
- `khuzait_slave_escape` → `slave_escape_node1`

### 问题 2：非预设流程错误

#### 2.1 非预设不应该选择文化

**当前流程**：
1. `origin_type_selection` → 选择"非预设出身"
2. `non_preset_culture_anchor` → 选择文化（❌ 不需要）
3. `non_preset_social_origin` → 选择社会出身

**预期流程**：
1. `origin_type_selection` → 选择"非预设出身"
2. `non_preset_social_origin` → 直接进入社会出身菜单（✅ 跳过文化选择）

**原因**：开局时游戏会要求玩家选择文化，所以在角色创建中不需要再选择文化。

#### 2.2 非预设显示游牧营地节点

**可能原因**：
- `non_preset_social_origin` 菜单的选项可能有问题
- 或者路由到了错误的菜单
- 或者菜单的 `InputMenuId` 设置错误，导致引擎匹配到了游牧营地的菜单

## 需要确认的信息

### 1. 预设出身的节点菜单是否存在

**检查方法**：
- 搜索代码中是否有 `CreateRebelChiefNode1Menu`、`CreateMinorNobleNode1Menu` 等方法
- 检查这些菜单的 `StringId` 是否正确
- 检查这些菜单的 `InputMenuId` 是否设置为 `"preset_origin_selection"`

**可能的问题**：
- 节点菜单没有创建
- 节点菜单的 `StringId` 写错了
- 节点菜单的 `InputMenuId` 设置错误

### 2. 非预设文化选择菜单的用途

**问题**：`non_preset_culture_anchor` 菜单是否应该存在？

**选项 A**：完全删除 `non_preset_culture_anchor` 菜单
- 优点：简单直接
- 缺点：如果其他地方引用了这个菜单，可能会出错

**选项 B**：保留菜单，但修改路由逻辑
- 优点：保留菜单定义，不影响其他代码
- 缺点：需要确保没有其他地方会进入这个菜单

**选项 C**：修改 `non_preset_culture_anchor` 菜单，让它直接跳转到 `non_preset_social_origin`
- 优点：保留菜单结构
- 缺点：用户可能会看到一闪而过的文化选择菜单

### 3. 非预设显示游牧营地节点的原因

**可能原因**：
- `non_preset_social_origin` 菜单的选项定义有问题
- 菜单的 `InputMenuId` 设置错误，导致引擎匹配到了游牧营地的菜单
- 路由逻辑错误，实际进入了错误的菜单

**检查方法**：
- 查看日志中的 `CandidateNext` 列表，确认实际匹配到了哪些菜单
- 检查 `non_preset_social_origin` 菜单的定义
- 检查所有菜单的 `InputMenuId`，确认是否有冲突

## 建议的修复方案

### 方案 1：完善预设出身路由

在 `TrySwitchToNextMenu` Prefix 中添加所有预设出身的路由：

```csharp
if (cm.StringId == "preset_origin_selection")
{
    // ...
    string nextId = null;
    switch (opt.StringId)
    {
        case "khuzait_rebel_chief":
            nextId = "rebel_chief_node1";
            break;
        case "khuzait_minor_noble":
            nextId = "minor_noble_node1";
            break;
        case "khuzait_migrant_chief":
            nextId = "migrant_chief_node1";
            break;
        case "khuzait_army_deserter":
            nextId = "army_deserter_node1";
            break;
        case "khuzait_trade_protector":
            nextId = "trade_protector_node1";
            break;
        case "khuzait_wandering_prince":
            nextId = "wandering_prince_node1";
            break;
        case "khuzait_khans_mercenary":
            nextId = "khans_mercenary_node1";
            break;
        case "khuzait_slave_escape":
            nextId = "slave_escape_node1";
            break;
    }
}
```

### 方案 2：非预设跳过文化选择

修改 `origin_type_selection` 的路由逻辑：

```csharp
if (opt.StringId == "non_preset_origin_option")
{
    // 直接跳转到社会出身菜单，跳过文化选择
    nextId = "non_preset_social_origin";  // 而不是 "non_preset_culture_anchor"
}
```

### 方案 3：检查非预设菜单定义

检查 `non_preset_social_origin` 菜单：
- 确认菜单的 `StringId` 是否正确
- 确认菜单的 `InputMenuId` 是否正确
- 确认菜单的选项是否正确
- 确认没有其他菜单的 `InputMenuId` 冲突

## 需要 ChatGPT 帮助的问题

### 问题 1：预设出身的节点菜单命名规则

**问题**：预设出身的节点菜单的 `StringId` 是什么？

**需要确认**：
- `khuzait_rebel_chief` 对应的节点菜单是 `rebel_chief_node1` 还是其他名称？
- 是否有统一的命名规则？
- 如何确认节点菜单的 `StringId`？

### 问题 2：非预设流程的正确设计

**问题**：非预设出身应该走什么流程？

**选项**：
- A. `origin_type_selection` → `non_preset_social_origin`（跳过文化选择）
- B. `origin_type_selection` → `non_preset_culture_anchor` → `non_preset_social_origin`（保留文化选择，但自动选择或跳过）

**需要确认**：
- 游戏开局时选择文化是在哪个阶段？
- 角色创建中的文化选择是否会影响游戏？
- 如果跳过文化选择，如何确保文化信息正确设置？

### 问题 3：非预设显示游牧营地节点的原因

**问题**：为什么非预设出身会显示游牧营地的节点？

**可能原因**：
- 菜单的 `InputMenuId` 冲突
- 路由逻辑错误
- 菜单选项定义错误

**需要确认**：
- 如何查看实际匹配到的菜单？
- 如何确认菜单的 `InputMenuId` 是否正确？
- 如何调试菜单匹配逻辑？

## 调试建议

### 1. 添加详细日志

在 `TrySwitchToNextMenu` Prefix 中添加日志：

```csharp
if (cm.StringId == "preset_origin_selection")
{
    LogInfo($"preset_origin_selection: 选中的选项 = {opt.StringId}");
    LogInfo($"CandidateNext 列表:");
    foreach (var m in mgr.NarrativeMenus.Where(m => m.InputMenuId == "preset_origin_selection"))
    {
        LogInfo($"  - {m.StringId}");
    }
}
```

### 2. 检查菜单定义

搜索代码中所有菜单的定义，确认：
- 节点菜单的 `StringId` 是否正确
- 节点菜单的 `InputMenuId` 是否设置为 `"preset_origin_selection"`
- 非预设菜单的 `InputMenuId` 是否正确

### 3. 测试路由逻辑

运行游戏，选择不同的预设出身，查看日志：
- 确认 `opt.StringId` 的实际值
- 确认路由到的 `nextId` 是否正确
- 确认 `CandidateNext` 列表中的菜单

## 代码位置

- **预设出身路由逻辑**：`OriginSystemPatches.cs` 第 5614-5635 行
- **非预设路由逻辑**：`OriginSystemPatches.cs` 第 5596-5600 行
- **non_preset_culture_anchor 菜单定义**：`OriginSystemPatches.cs` 第 4109 行附近
- **non_preset_social_origin 菜单定义**：`OriginSystemPatches.cs` 第 4258 行附近









































